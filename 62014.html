<html lang="en">
<body>
<pre>
From 66722cfab9e385b5493d294f3a43209cf5dee61b Mon Sep 17 00:00:00 2001
From: Olaf Faaland <faaland1@llnl.gov>
Date: Thu, 23 Oct 2025 10:20:47 -0700
Subject: [PATCH 1/1] LU-19517 lnet: ping timeout based on
 lnet_transaction_timeout

If the user doesn't specify a timeout for lnetctl ping, calculate a
default value based on lnet_transaction_timeout instead of using a
fixed value.

No fixed value is correct if the site has both large networks and very
small ones, and uses the same Lustre build everywhere.

Signed-off-by: Olaf Faaland <faaland1@llnl.gov>
Change-Id: If9afdc48139b78394dd8fe3e6c476a27447e8f56
---
 Documentation/man8/lnetctl.8 |  3 ++-
 lnet/lnet/api-ni.c           | 10 ++++------
 lnet/utils/lnetctl.c         |  6 +++---
 lustre/utils/portals.c       |  6 ++----
 4 files changed, 11 insertions(+), 14 deletions(-)

diff --git a/Documentation/man8/lnetctl.8 b/Documentation/man8/lnetctl.8
index c818ec2a60..637f7d86ec 100644
--- a/Documentation/man8/lnetctl.8
+++ b/Documentation/man8/lnetctl.8
@@ -67,7 +67,8 @@ are optional\.
 .
 .br
 \-\-peer\-timeout: time to wait before declaring a peer dead (in seconds).
-Default value for o2iblnd and socklnd is 180 seconds.
+Default value for o2iblnd and socklnd is the number of seconds specified by
+lnet module parameter lnet_transaction_timeout.
 .
 .br
 \-\-peer\-credits: define the max number of in\-flight messages per peer.
diff --git a/lnet/lnet/api-ni.c b/lnet/lnet/api-ni.c
index 968fc7a359..46f6109159 100644
--- a/lnet/lnet/api-ni.c
+++ b/lnet/lnet/api-ni.c
@@ -4874,11 +4874,9 @@ LNetCtl(unsigned int cmd, void *arg)
 		if (ping->ping_hdr.ioc_len >= sizeof(struct lnet_ioctl_ping_data))
 			lnet_nid4_to_nid(ping->ping_src, &src_nid);
 
-		/* If timeout is negative then set default of 3 minutes */
-		if (((s32)ping->op_param) <= 0 ||
-		    ping->op_param > (DEFAULT_PEER_TIMEOUT * MSEC_PER_SEC))
-			timeout = cfs_time_seconds(DEFAULT_PEER_TIMEOUT);
-		else
+		timeout = cfs_time_seconds(lnet_transaction_timeout);
+		if (((s32)ping->op_param) > 0 &&
+		    ping->op_param <= (DEFAULT_PEER_TIMEOUT * MSEC_PER_SEC))
 			timeout = nsecs_to_jiffies(ping->op_param * NSEC_PER_MSEC);
 
 		id.pid = ping->ping_id.pid;
@@ -8333,7 +8331,7 @@ static int lnet_ping_show_start(struct netlink_callback *cb)
 		return -ENOMEM;
 	}
 	genradix_init(&plist->lgpl_list);
-	plist->lgpl_timeout = cfs_time_seconds(DEFAULT_PEER_TIMEOUT);
+	plist->lgpl_timeout = cfs_time_seconds(lnet_transaction_timeout);
 	plist->lgpl_src_nid = LNET_ANY_NID;
 	plist->lgpl_index = 0;
 	plist->lgpl_list_count = 0;
diff --git a/lnet/utils/lnetctl.c b/lnet/utils/lnetctl.c
index f70c12c60c..5b3927e5f2 100644
--- a/lnet/utils/lnetctl.c
+++ b/lnet/utils/lnetctl.c
@@ -6198,7 +6198,7 @@ static int yaml_lnet_ping(char *group, int timeout, struct lnet_nid *src_nid,
 	if (rc == 0)
 		goto emitter_error;
 
-	if (timeout != 1000 || (src_nid && nid_addr_is_set(src_nid))) {
+	if (timeout > 0 || (src_nid && nid_addr_is_set(src_nid))) {
 		if (src_nid && nid_addr_is_set(src_nid)) {
 			char *src_nidstr = libcfs_nidstr(src_nid);
 
@@ -6221,7 +6221,7 @@ static int yaml_lnet_ping(char *group, int timeout, struct lnet_nid *src_nid,
 				goto emitter_error;
 		}
 
-		if (timeout != 1000) {
+		if (timeout > 0) {
 			char time[23];
 
 			yaml_scalar_event_initialize(&event, NULL,
@@ -6336,7 +6336,7 @@ static int jt_ping(int argc, char **argv)
 	struct cYAML *err_rc = NULL;
 	struct cYAML *show_rc = NULL;
 	struct lnet_nid src = { };
-	int timeout = 1000;
+	int timeout = -1; /* set default based on lnet_transaction_timeout */
 	int rc = 0, opt;
 	char *src_nidstr = NULL;
 	const char *const short_options = "hs:t:";
diff --git a/lustre/utils/portals.c b/lustre/utils/portals.c
index 5f21126dcb..e6ecf06f81 100644
--- a/lustre/utils/portals.c
+++ b/lustre/utils/portals.c
@@ -1300,7 +1300,7 @@ int jt_ptl_ping(int argc, char **argv)
 {
 	bool done = false, print = true;
 	int rc;
-	int timeout;
+	int timeout = -1; /* set default based on lnet_transaction_timeout */
 	struct lnet_processid id;
 	yaml_emitter_t request;
 	yaml_parser_t reply;
@@ -1349,8 +1349,6 @@ int jt_ptl_ping(int argc, char **argv)
 				argv[2]);
 			return -EINVAL;
 		}
-	} else {
-		timeout = 1000; /* default 1 second timeout */
 	}
 
 	/* Create Netlink emitter to send request to kernel */
@@ -1407,7 +1405,7 @@ int jt_ptl_ping(int argc, char **argv)
 	if (rc == 0)
 		goto emitter_error;
 
-	if (timeout != 1000) {
+	if (timeout > 0) {
 		yaml_scalar_event_initialize(&event, NULL,
 					     (yaml_char_t *)YAML_STR_TAG,
 					     (yaml_char_t *)"timeout",

</pre>
</body>
</html>
