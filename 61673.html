From e4120a72c650ddaed05247a5a54a388a6cdf5570 Mon Sep 17 00:00:00 2001
From: Timothy Day <timday@amazon.com>
Date: Tue, 30 Sep 2025 19:55:34 +0000
Subject: [PATCH 1/1] LU-19363 kefalnd: enable kefalnd if headers can be found

If the EFA driver has already been installed or you are
using a kernel with the appropriate EFA driver version,
configure should automatically detect this and enable the
EFA Lustre network driver (similar to how o2iblnd works
today).

Also, fix some typos.

Test-Parameters: trivial
Signed-off-by: Timothy Day <timday@amazon.com>
Change-Id: Ia96ccf931f2ea0a9ce4c90bbbf45b57405800e2a
---
 config/lustre-lnet.m4 | 66 ++++++++++++++++++++++++++-----------------
 1 file changed, 40 insertions(+), 26 deletions(-)

diff --git a/config/lustre-lnet.m4 b/config/lustre-lnet.m4
index 3c16434723..e3da70e25c 100644
--- a/config/lustre-lnet.m4
+++ b/config/lustre-lnet.m4
@@ -875,33 +875,12 @@ AC_MSG_CHECKING([whether to enable EFA LND])
 AC_ARG_ENABLE([efa],
 	AS_HELP_STRING([--enable-efa=[yes|no|<path>]],
 		       [enable EFA LND]),
-	[], [enable_efa="no"])
+	[], [ENABLE_EFA="yes"])
 
 AS_CASE([$enable_efa],
 	[yes],
 	[
-		AS_IF([test x$uses_dpkg = xyes], [
-			LS_PKG="dpkg --listfiles"
-		], [
-			LS_PKG="rpm -ql"
-		])
-
-		EFA_PKG="efa"
-		EFA_HEADER="efa_verbs.h"
-		EFA_HEADER_PATH=$(eval "$LS_PKG $EFA_PKG" | egrep "$EFA_HEADER" | head -n1)
-		AS_IF([test -n "$EFA_HEADER_PATH"], [
-			EFA_INCLUDE_PATH=$(dirname $EFA_HEADER_PATH)
-		])
-
-		KERNEL_RDMA_INCLUDE="$LINUX/include/rdma"
-		AS_IF([test -z "$EFA_INCLUDE_PATH" && test -f "$KERNEL_RDMA_INCLUDE/$EFA_HEADER"], [
-			EFA_INCLUDE_PATH=$KERNEL_RDMA_INCLUDE
-		])
-
-		AS_IF([test -z "$EFA_INCLUDE_PATH"], [
-			AC_MSG_ERROR([Could not find a supported EFA driver. For custom built driver, the path to header files can be supplied using --enable-efa=<path>.])
-		])
-
+		EFA_MANUALLY_ENABLED=1
 		ENABLE_EFA="yes"
 	],
 	[no],
@@ -910,9 +889,44 @@ AS_CASE([$enable_efa],
 	],
 	[
 		EFA_INCLUDE_PATH=$enable_efa
+
+		AS_IF([test -n "$EFA_INCLUDE_PATH"], [
+			EFA_MANUALLY_ENABLED=1
+		])
+
 		ENABLE_EFA="yes"
 	])
 
+# If EFA is enabled, try to find the headers
+AS_IF([test $ENABLE_EFA = "yes" && test -z "$EFA_INCLUDE_PATH"], [
+	AS_IF([test x$uses_dpkg = xyes], [
+		LS_PKG="dpkg --listfiles"
+	], [
+		LS_PKG="rpm -ql"
+	])
+
+	EFA_PKG="efa"
+	EFA_HEADER="efa_verbs.h"
+	EFA_HEADER_PATH=$(eval "$LS_PKG $EFA_PKG" | egrep "$EFA_HEADER" | head -n1)
+	AS_IF([test -n "$EFA_HEADER_PATH"], [
+		EFA_INCLUDE_PATH=$(dirname $EFA_HEADER_PATH)
+	])
+
+	KERNEL_RDMA_INCLUDE="$LINUX/include/rdma"
+	AS_IF([test -z "$EFA_INCLUDE_PATH" && test -f "$KERNEL_RDMA_INCLUDE/$EFA_HEADER"], [
+		EFA_INCLUDE_PATH=$KERNEL_RDMA_INCLUDE
+	])
+])
+
+# If we still can't find the headers, give up...
+AS_IF([test -z "$EFA_INCLUDE_PATH"], [
+	ENABLE_EFA="no"
+])
+
+AS_IF([test -n "$EFA_MANUALLY_ENABLED" && test $ENABLE_EFA = "no"], [
+	AC_MSG_ERROR([Could not find a supported EFA driver. For custom built driver, the path to header files can be supplied using --enable-efa=<path>.])
+])
+
 AS_IF([test $ENABLE_EFA = "no"], [
 	AC_MSG_RESULT([no])
 ], [
@@ -926,7 +940,7 @@ AS_IF([test $ENABLE_EFA = "no"], [
 	],[
 		ib_device_get_by_name(NULL, 0);
 	],[],[
-		AC_MSG_ERROR([EFA LND is not supported with this Linux kerenel])
+		AC_MSG_ERROR([EFA LND is not supported with this Linux kernel])
 	])
 
 	LB_CHECK_COMPILE([if 'RDMA_DRIVER_EFA' exists],
@@ -935,7 +949,7 @@ AS_IF([test $ENABLE_EFA = "no"], [
 	],[
 		int x = RDMA_DRIVER_EFA;
 	],[],[
-		AC_MSG_ERROR([EFA LND is not supported with this Linux kerenel])
+		AC_MSG_ERROR([EFA LND is not supported with this Linux kernel])
 	])
 
 	LB_CHECK_COMPILE([if ib_device 'kverbs_provider' flag exists],
@@ -946,7 +960,7 @@ AS_IF([test $ENABLE_EFA = "no"], [
 			.kverbs_provider = 0,
 		};
 	],[],[
-		AC_MSG_ERROR([EFA LND is not supported with this Linux kerenel])
+		AC_MSG_ERROR([EFA LND is not supported with this Linux kernel])
 	])
 
 	# Check optional kernel definitions
