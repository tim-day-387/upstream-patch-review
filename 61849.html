<html lang="en">
<body>
<pre>
From 25b959ab333bcc506dfd86e1502fe62c6ca69207 Mon Sep 17 00:00:00 2001
From: Marc Vef <mvef@whamcloud.com>
Date: Thu, 16 Oct 2025 02:53:27 +0200
Subject: [PATCH 1/1] LU-19478 tests: remove sleep in wait_nm_sync in local
 mode

When wait_nm_sync() detects that the MGS is colocated with the MDS and
OSS, it uses an arbitrary 10 second sleep to wait for nodemap
synchronization to finish. However, in this configuration there is no
synchronization of the nodemap file and changes to the nodemap file
are instant (all server types use the same ptlrpc layer where the
nodemap is located).

There are further restrictions in sanity-sec tests 27* and 72* which
skip the test if the MGS and MDS/OSS are colocated because it is not
possible to tell when synchronization has occurred. This is not
required either due to the same argument as above. In fact, it is
preferred to still run these tests in this "merged" server
configuration as it increases test coverage for these configurations.

This patch removes these restrictions from the corresponding tests and
wait_nm_sync, increasing test coverage and speed.

Test-Parameters: trivial
Test-Parameters: testlist=sanity-sec
Test-Parameters: testlist=sanity-sec combinedmdsmgs=false mdscount=1 mdtcount=2 osscount=1 ostcount=8
Signed-off-by: Marc Vef <mvef@whamcloud.com>
Change-Id: Ib87b4e16e3d2207e7f0c2c8c9cdfe46ce56eab5c
---
 lustre/tests/sanity-sec.sh     | 71 ++++++++++++++--------------------
 lustre/tests/test-framework.sh |  6 +--
 2 files changed, 31 insertions(+), 46 deletions(-)

diff --git a/lustre/tests/sanity-sec.sh b/lustre/tests/sanity-sec.sh
index f34133276d..d13621c3ea 100755
--- a/lustre/tests/sanity-sec.sh
+++ b/lustre/tests/sanity-sec.sh
@@ -2058,6 +2058,9 @@ test_25a() {
 
 	nodemap_version_check || return 0
 
+	# in local mode the exports order on the nodemap cannot be compared
+	local_mode && skip "test does not support local mode"
+
 	# stop clients for this test
 	zconf_umount_clients $CLIENTS $MOUNT ||
 	    error "unable to umount clients $CLIENTS"
@@ -2522,13 +2525,6 @@ test_27a() {
 	(( $MDS1_VERSION < $(version_code 2.11.50) )) &&
 		skip "Need MDS >= 2.11.50"
 
-	# if servers run on the same node, it is impossible to tell if they get
-	# synced with the mgs, so this test needs to be skipped
-	if [[ $(facet_active_host mgs) == $(facet_active_host mds) ]] &&
-	   [[ $(facet_active_host mgs) == $(facet_active_host ost1) ]]; then
-		skip "local mode not supported"
-	fi
-
 	for nm in "default" "c0"; do
 		if [[ "$nm" == "default" && "$SHARED_KEY" == "true" ]]; then
 			echo "Skipping nodemap $nm with SHARED_KEY"
@@ -2969,13 +2965,6 @@ test_27b() { #LU-10703
 
 	(( MDSCOUNT < 2 )) && skip "needs >= 2 MDTs"
 
-	# if servers run on the same node, it is impossible to tell if they get
-	# synced with the mgs, so this test needs to be skipped
-	if [[ $(facet_active_host mgs) == $(facet_active_host mds) ]] &&
-	   [[ $(facet_active_host mgs) == $(facet_active_host ost1) ]]; then
-		skip "local mode not supported"
-	fi
-
 	nodemap_test_setup
 	trap nodemap_test_cleanup EXIT
 
@@ -3025,13 +3014,6 @@ test_27c() {
 	is_multi_fileset_supported ||
 		skip "Need MGS >= 2.16.57 for multiple filesets"
 
-	# if servers run on the same node, it is impossible to tell if they get
-	# synced with the mgs, so this test needs to be skipped
-	if [[ $(facet_active_host mgs) == $(facet_active_host mds) ]] &&
-	   [[ $(facet_active_host mgs) == $(facet_active_host ost1) ]]; then
-		skip "local mode not supported"
-	fi
-
 	# clients are re-mounted later when all filesets are removed
 	stack_trap nodemap_exercise_fileset_cleanup EXIT
 
@@ -3301,13 +3283,6 @@ multi_fileset_test_run() {
 	is_multi_fileset_supported ||
 		skip "Need MGS >= 2.16.57 for multiple filesets"
 
-	# if servers run on the same node, it is impossible to tell if they get
-	# synced with the mgs, so this test needs to be skipped
-	if [[ $(facet_active_host mgs) == $(facet_active_host mds) ]] &&
-	   [[ $(facet_active_host mgs) == $(facet_active_host ost1) ]]; then
-		skip "local mode not supported"
-	fi
-
 	local mult_fset_root=$tdir
 	local fs_root=$tfile
 
@@ -3500,13 +3475,6 @@ test_27f() {
 	is_multi_fileset_supported ||
 		skip "Need MGS >= 2.16.57 for multiple filesets"
 
-	# if servers run on the same node, it is impossible to tell if they get
-	# synced with the mgs, so this test needs to be skipped
-	if [[ $(facet_active_host mgs) == $(facet_active_host mds) &&
-	      $(facet_active_host mgs) == $(facet_active_host ost1) ]]; then
-		skip "local mode not supported"
-	fi
-
 	stack_trap nodemap_test_cleanup EXIT
 
 	nodemap_test_setup
@@ -8230,6 +8198,7 @@ dyn_nm_helper() {
 	rbac_val=$(do_facet mgs $LCTL get_param -n nodemap.$mgsnm.rbac)
 
 	stack_trap "do_facet $facet $LCTL nodemap_del $nm || true" EXIT
+	# check that persistent nodemap cannot be created on non MGS nodes
 	if [[ "$(facet_active_host mgs)" != \
 			"$(facet_active_host $facet)" ]]; then
 		do_facet $facet $LCTL nodemap_add $nm &&
@@ -8412,6 +8381,7 @@ dyn_nm_helper() {
 	val=$(do_facet $facet $LCTL get_param nodemap.$nm.id)
 	[[ -z "$val" ]] || error "nodemap should be gone, got $val"
 
+	# changes to persistent nodemaps should not be possible on non-MGS nodes
 	if [[ "$(facet_active_host mgs)" != \
 			"$(facet_active_host $facet)" ]]; then
 		do_facet $facet $LCTL nodemap_add_range --name $mgsnm \
@@ -8439,9 +8409,6 @@ test_72a() {
 	(( OST1_VERSION >= $(version_code 2.16.54) )) ||
 		skip "Need OSS >= 2.16.54 dynamic nodemaps"
 
-	[[ "$(facet_active_host mgs)" != "$(facet_active_host ost1)" ]] ||
-		skip "Need servers on different hosts"
-
 	dyn_nm_helper ost1
 }
 run_test 72a "dynamic nodemap properties on OSS"
@@ -8590,12 +8557,18 @@ test_72d() {
 	local nm=nm_test72d
 	local nm2=subnm_test72d
 	local val
+	local same_server_node=false
 
 	is_multi_fileset_supported "ost1" ||
 		skip "Need OSS >= 2.16.57 for multiple filesets"
 
-	[[ "$(facet_active_host mgs)" != "$(facet_active_host ost1)" ]] ||
-		skip "Need servers on different hosts"
+	# When MGS and OST are colocated, we need to explicitly remove the
+	# dynamic nodemap.
+	# FIXME we should be able to rely on the nodemap synchronization wiping
+	# all dynamic nodemaps even if the MGS and OST are colocated. In this
+	# case, "same_server_node" should be removed and not separately handled.
+	[[ "$(facet_active_host mgs)" == "$(facet_active_host ost1)" ]] &&
+		same_server_node=true
 
 	stack_trap "cleanup_72d $mgsnm $nm $nm2" EXIT
 
@@ -8638,6 +8611,10 @@ test_72d() {
 		error "modify fileset for $mgsnm on MGS failed"
 	wait_nm_sync $mgsnm fileset '' inactive
 
+	if $same_server_node; then
+		do_facet ost1 $LCTL nodemap_del $nm
+	fi
+
 	do_facet ost1 $LCTL nodemap_add -d -p $mgsnm $nm ||
 		error "dynamic nodemap on server failed (2)"
 	val=$(do_facet ost1 $LCTL get_param -n nodemap.$nm.id)
@@ -8861,13 +8838,19 @@ test_72f() {
 	local fileset_prim="/primary"
 	local fileset_alt1="/alt1"
 	local fileset_alt2="/alt2"
+	local same_server_node=false
 	local val
 
 	is_multi_fileset_supported "ost1" ||
 		skip "Need OSS >= 2.16.57 for multiple filesets"
 
-	[[ "$(facet_active_host mgs)" != "$(facet_active_host ost1)" ]] ||
-		skip "Need servers on different hosts"
+	# When MGS and OST are colocated, we need to explicitly remove the
+	# dynamic nodemap.
+	# FIXME we should be able to rely on the nodemap synchronization wiping
+	# all dynamic nodemaps even if the MGS and OST are colocated. In this
+	# case, "same_server_node" should be removed and not separately handled.
+	[[ "$(facet_active_host mgs)" == "$(facet_active_host ost1)" ]] &&
+		same_server_node=true
 
 	stack_trap "cleanup_72f $mgsnm $nm" EXIT
 
@@ -8943,6 +8926,10 @@ test_72f() {
 		error "add fileset $fileset_alt2 to $mgsnm failed"
 	wait_nm_sync $mgsnm fileset '' inactive
 
+	if $same_server_node; then
+		do_facet ost1 $LCTL nodemap_del $nm
+	fi
+
 	# create dynamic nodemap
 	do_facet ost1 $LCTL nodemap_add -d -p $mgsnm $nm ||
 		error "dynamic nodemap on server failed"
diff --git a/lustre/tests/test-framework.sh b/lustre/tests/test-framework.sh
index 5d98eab7ca..2ee5f6c399 100755
--- a/lustre/tests/test-framework.sh
+++ b/lustre/tests/test-framework.sh
@@ -12480,12 +12480,10 @@ wait_nm_sync() {
 		out1=$value;
 	fi
 
-	# if servers run on the same node, it is impossible to tell if they get
-	# synced with the mgs, so just wait an arbitrary 10 seconds
+	# if servers run on the same node, no synchronization is done.
+	# Therefore, we can skip the sync check without waiting.
 	if [[ $(facet_active_host mgs) == $(facet_active_host mds) &&
 	      $(facet_active_host mgs) == $(facet_active_host ost1) ]]; then
-		echo "waiting 10 secs for sync"
-		sleep 10
 		return 0
 	fi
 

</pre>
</body>
</html>
