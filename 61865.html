From 87496c26e95dae2ac3eb14c46f9fff662107ec94 Mon Sep 17 00:00:00 2001
From: Jian Yu <yujian@whamcloud.com>
Date: Thu, 16 Oct 2025 16:45:18 -0700
Subject: [PATCH 1/1] LU-18181 tests: check OST pool exists before getting
 quota info

This patch adds a check in conf-sanity.sh t32_verify_quota() to
make sure the OST pool exists before running lfs quota to get
the quota info.

Test-Parameters: trivial fstype=ldiskfs mdtcount=4 mdscount=2 \
  env=SLOW=yes,ENABLE_QUOTA=yes,ONLY=32h,ONLY_REPEAT=10 \
  testlist=conf-sanity

Test-Parameters: trivial fstype=zfs mdtcount=4 mdscount=2 \
  env=SLOW=yes,ENABLE_QUOTA=yes,ONLY=32h,ONLY_REPEAT=10 \
  testlist=conf-sanity

Change-Id: I513de810bc395d492c64e269299f029b97cc3e32
Signed-off-by: Jian Yu <yujian@whamcloud.com>
---
 lustre/tests/conf-sanity.sh | 10 +++++++++-
 1 file changed, 9 insertions(+), 1 deletion(-)

diff --git a/lustre/tests/conf-sanity.sh b/lustre/tests/conf-sanity.sh
index 5a42388945..755fd5a500 100755
--- a/lustre/tests/conf-sanity.sh
+++ b/lustre/tests/conf-sanity.sh
@@ -1921,7 +1921,15 @@ t32_verify_quota() {
 			return 1
 		}
 
-		$LFS quota -v -u $T32_QID --pool $qpool $pool_dir
+		do_facet mgs "$LCTL pool_list $fsname.$qpool" || {
+			echo "$LCTL pool_list $fsname.$qpool failed"
+			return 1
+		}
+
+		$LFS quota -v -u $T32_QID --pool $qpool $pool_dir || {
+			echo "$LFS quota $pool_dir failed"
+			return 1
+		}
 
 		qval=$(DIR=$pool_dir getquota -u $T32_QID \
 		       global curspace $qpool)
