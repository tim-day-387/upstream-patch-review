<html lang="en">
<body>
<pre>
From bae101ff171b474de151ab337a793a773ed4e72b Mon Sep 17 00:00:00 2001
From: Maximilian Dilger <mdilger@whamcloud.com>
Date: Thu, 17 Oct 2024 15:30:10 -0600
Subject: [PATCH 1/1] LU-17551 utils: Removed "ed" and "quilt" dependancies

This patch replaced any found usages of the "ed" package with the
"sed" command instead. Quilt has also been completely removed and
instead uses patch where applicable.

Signed-off-by: Maximilian Dilger <mdilger@whamcloud.com>
Change-Id: I347857d4a3d31c54fc9956d42b68b7958ef46a35
---
 autoMakefile.am                   |  4 ++--
 config/lustre-build-ldiskfs.m4    | 36 +------------------------------
 config/lustre-build.m4            |  1 -
 contrib/lbuild/lbuild             |  2 +-
 contrib/quiltrc                   |  2 --
 contrib/scripts/get_maintainer.pl |  4 ++--
 debian/control.main               |  2 +-
 debian/dkms.conf.in               |  2 +-
 debian/rules                      |  6 +++---
 ldiskfs/README                    | 16 +++++++++++---
 ldiskfs/autoMakefile.am           |  6 ------
 11 files changed, 24 insertions(+), 57 deletions(-)
 delete mode 100644 contrib/quiltrc

diff --git a/autoMakefile.am b/autoMakefile.am
index ea1f3763b1..98270ec55a 100644
--- a/autoMakefile.am
+++ b/autoMakefile.am
@@ -345,7 +345,7 @@ debs: undef.h debs_common
 	lversion=$$(echo @VERSION@ | tr '_' '-'); \
 	cversion=$$(sed -ne '1s/^lustre (\(.*\)-[0-9][0-9]*).*$$/\1/p' debian/changelog); \
 	if [ "$$lversion" != "$$cversion" ]; then \
-		echo -e "1i\nlustre ($$lversion-1) unstable; urgency=low\n\n  * Automated changelog entry update\n\n -- Andreas Dilger <adilger@whamcloud.com>  $$(date -R)\n\n.\nwq" | ed debian/changelog; \
+		sed -i "1i lustre (\$$lversion-1) unstable; urgency=low\n\n  * Automated changelog entry update\n\n -- Andreas Dilger <adilger@whamcloud.com>  \$$(date -R)" debian/changelog; \
 	fi; \
 	rm -rf debs; \
 	if test "x@ENABLE_SERVER@" = "xyes"; then \
@@ -590,7 +590,7 @@ dkms-debs: undef.h debs_common
 	lversion=$$(echo @VERSION@ | tr '_' '-'); \
 	cversion=$$(sed -ne '1s/^lustre (\(.*\)-[0-9][0-9]*).*$$/\1/p' debian/changelog); \
 	if [ "$$lversion" != "$$cversion" ]; then \
-		echo -e "1i\nlustre ($$lversion-1) unstable; urgency=low\n\n  * Automated changelog entry update\n\n -- Brian J. Murrell <brian@interlinx.bc.ca>  $$(date -R)\n\n.\nwq" | ed debian/changelog; \
+		sed -i "1i lustre (\$$lversion-1) unstable; urgency=low\n\n  * Automated changelog entry update\n\n -- Brian J. Murrell <brian@interlinx.bc.ca> \$$(date -R)" debian/changelog; \
 	fi; \
 	rm -rf debs; \
 	export DEB_BUILD_PROFILES="client"; \
diff --git a/config/lustre-build-ldiskfs.m4 b/config/lustre-build-ldiskfs.m4
index 6710b5cbca..d3ce1083ad 100644
--- a/config/lustre-build-ldiskfs.m4
+++ b/config/lustre-build-ldiskfs.m4
@@ -415,39 +415,6 @@ AC_DEFUN([LB_LDISKFS_IGET_EA_INODE], [
 	])
 ]) # LB_LDISKFS_IGET_EA_INODE
 
-#
-# LDISKFS_AC_PATCH_PROGRAM
-#
-# Determine which program should be used to apply the patches to
-# the ext4 source code to produce the ldiskfs source code.
-#
-AC_DEFUN([LDISKFS_AC_PATCH_PROGRAM], [
-	AC_ARG_ENABLE([quilt],
-		[AS_HELP_STRING([--disable-quilt],
-			[disable use of quilt for ldiskfs])],
-		[AS_IF([test "x$enableval" = xno],
-			[use_quilt=no],
-			[use_quilt=maybe])],
-		[use_quilt=maybe]
-	)
-
-	AS_IF([test x$use_quilt = xmaybe], [
-		AC_PATH_PROG([quilt_avail], [quilt], [no])
-		AS_IF([test x$quilt_avail = xno], [
-			use_quilt=no
-		], [
-			use_quilt=yes
-		])
-	])
-
-	AS_IF([test x$use_quilt = xno], [
-		AC_PATH_PROG([patch_avail], [patch], [no])
-		AS_IF([test x$patch_avail = xno], [
-			AC_MSG_ERROR([*** Need "quilt" or "patch" command])
-		])
-	])
-]) # LDISKFS_AC_PATCH_PROGRAM
-
 #
 # LB_LDISKFS_FIND_ENTRY_LOCKED_EXISTS
 #
@@ -662,7 +629,6 @@ AS_IF([test x$enable_ldiskfs != xno],[
 	AC_SUBST(ENABLE_LDISKFS, yes)
 
 	LDISKFS_LINUX_SERIES
-	LDISKFS_AC_PATCH_PROGRAM
 	LB_EXT4_INC_DEC_COUNT_2ARGS
 	LB_EXT4_JOURNAL_GET_WRITE_ACCESS_4A
 	LB_HAVE_INODE_LOCK_SHARED
@@ -702,7 +668,7 @@ AC_DEFUN([LB_KABI_LDISKFS], [AS_IF([test x$enable_ldiskfs != xno],[
 		LB_EXT4_HAVE_I_CRYPT_INFO
 		LB_LDISKFS_JOURNAL_ENSURE_CREDITS
 		LB_LDISKFS_IGET_HAS_FLAGS_ARG
-		LB_LDISKFS_IGET_EA_INODE
+		LB_SRC_LDISKFS_IGET_EA_INODE
 		LB_LDISKFS_FIND_ENTRY_LOCKED_EXISTS
 		LB_LDISKFSFS_DIRHASH_WANTS_DIR
 		LB_JBD2_H_TOTAL_CREDITS
diff --git a/config/lustre-build.m4 b/config/lustre-build.m4
index f92111d829..f8a4768a2c 100644
--- a/config/lustre-build.m4
+++ b/config/lustre-build.m4
@@ -411,7 +411,6 @@ AM_CONDITIONAL([TESTS], [test x$enable_tests = xyes])
 AM_CONDITIONAL([DOC], [test x$ENABLE_DOC = x1])
 AM_CONDITIONAL([MANPAGES], [test x$enable_manpages = xyes])
 AM_CONDITIONAL([LINUX], [test x$lb_target_os = xlinux])
-AM_CONDITIONAL([USE_QUILT], [test x$use_quilt = xyes])
 AM_CONDITIONAL([RHEL], [test -f /etc/redhat-release -o -f /etc/openEuler-release])
 AM_CONDITIONAL([SUSE], [test -f /etc/SUSE-brand -o -f /etc/SuSE-release])
 AM_CONDITIONAL([UBUNTU], [test x$UBUNTU_KERNEL = xyes])
diff --git a/contrib/lbuild/lbuild b/contrib/lbuild/lbuild
index d7b01cfd35..01e580c6d0 100755
--- a/contrib/lbuild/lbuild
+++ b/contrib/lbuild/lbuild
@@ -1400,7 +1400,7 @@ EOF
 			--define "$K_SRC ${linux}" \
 			${K_SRC_OBJ:+--define "$K_SRC_OBJ ${linux}"} \
 			${OFA_KERNEL_RELEASE:+--define "_release $OFA_KERNEL_RELEASE"} \
-			--define "configure_options --without-quilt $OFED_CORE $OFED_HARDWARE $OFED_ISCSI" \
+			--define "configure_options $OFED_CORE $OFED_HARDWARE $OFED_ISCSI" \
 			${SOURCE} 2>&1; then
 			fatal 1 "Error building ${kib_rpm}"
 		fi
diff --git a/contrib/quiltrc b/contrib/quiltrc
deleted file mode 100644
index 60ec0d901e..0000000000
--- a/contrib/quiltrc
+++ /dev/null
@@ -1,2 +0,0 @@
-export QUILT_DIFF_OPTS="-upa"
-export QUILT_NO_DIFF_TIMESTAMPS=1
diff --git a/contrib/scripts/get_maintainer.pl b/contrib/scripts/get_maintainer.pl
index d4a9b71bd6..15206cff3b 100755
--- a/contrib/scripts/get_maintainer.pl
+++ b/contrib/scripts/get_maintainer.pl
@@ -717,7 +717,7 @@ sub self_test {
 	    my $isbad = 0;
 	    if (grep(m@^\Q$value\E$@, @bad_links)) {
 	        $isbad = 1;
-            } elsif ($value !~ /^(?:git|quilt|hg)\s+\S/) {
+            } elsif ($value !~ /^(?:git|hg)\s+\S/) {
 		print("$x->{file}:$x->{linenr}: warning: malformed entry\t$x->{line}\n");
 	    } elsif ($value =~ /^git\s+(\S+)(\s+([^\(]+\S+))?/) {
 		my $url = $1;
@@ -730,7 +730,7 @@ sub self_test {
 		    push(@bad_links, $value);
 		    $isbad = 1;
 		}
-	    } elsif ($value =~ /^(?:quilt|hg)\s+(https?:\S+)/) {
+	    } elsif ($value =~ /^hg\s+(https?:\S+)/) {
 		my $url = $1;
 		my $output = `wget --spider -q --no-check-certificate --timeout 10 --tries 1 $url`;
 		if ($? == 0) {
diff --git a/debian/control.main b/debian/control.main
index 98c2113dd5..009af0108f 100644
--- a/debian/control.main
+++ b/debian/control.main
@@ -4,7 +4,7 @@ Priority: optional
 Maintainer: Lustre Developers <lustre-devel@lists.lustre.org>
 Uploaders: Lustre Developers <lustre-devel@lists.lustre.org>
 Standards-Version: 3.8.3
-Build-Depends: module-assistant, libreadline-dev, debhelper (>= 11), automake (>=1.7) | automake1.7 | automake1.8 | automake1.9, pkg-config, libtool, libyaml-dev, libnl-genl-3-dev, libselinux-dev, bzip2, quilt, linux-headers-generic | linux-headers-amd64 | linux-headers-arm64, rsync, libssl-dev, libpython3-dev, swig, libmount-dev, ed
+Build-Depends: module-assistant, libreadline-dev, debhelper (>= 11), automake (>=1.7) | automake1.7 | automake1.8 | automake1.9, pkg-config, libtool, libyaml-dev, libnl-genl-3-dev, libselinux-dev, bzip2, linux-headers-generic | linux-headers-amd64 | linux-headers-arm64, rsync, libssl-dev, libpython3-dev, swig, libmount-dev
 Homepage: https://wiki.whamcloud.com/
 Vcs-Git: git://git.whamcloud.com/fs/lustre-release.git
 
diff --git a/debian/dkms.conf.in b/debian/dkms.conf.in
index e8f07de54f..a6c511fa4c 100644
--- a/debian/dkms.conf.in
+++ b/debian/dkms.conf.in
@@ -25,7 +25,7 @@ no_weak_modules=yes
 strip_default=no
 OPTS=""
 if [[ "x${PACKAGE_NAME}" = "xlustre-client-modules" ]] ; then
-    OPTS="${OPTS} --disable-server --disable-quilt"
+    OPTS="${OPTS} --disable-server"
 fi
 [[ -f /usr/src/kfabric/default/Module.symvers ]] &&
     OPTS="${OPTS} --with-kfi=/usr/src/kfabric/default"
diff --git a/debian/rules b/debian/rules
index 0797f8260d..fdee783036 100755
--- a/debian/rules
+++ b/debian/rules
@@ -237,7 +237,7 @@ configure-stamp: autogen-stamp debian/control.main debian/control.modules.in
 	fi; \
 	if echo "$${DEB_BUILD_PROFILES}" | grep -q "ldiskfs"; then \
 		export EXTRAFLAGS="$${EXTRAFLAGS} \
-			--enable-ldiskfs --enable-quilt"; \
+			--enable-ldiskfs"; \
 	else \
 		export EXTRAFLAGS="$${EXTRAFLAGS} --disable-ldiskfs"; \
 	fi; \
@@ -571,10 +571,10 @@ kdist_config: prep-deb-files patch-stamp
 	fi; \
 	if echo "$${DEB_BUILD_PROFILES}" | grep -q "ldiskfs"; then \
 		export EXTRAFLAGS="$${EXTRAFLAGS} \
-			--enable-ldiskfs --enable-quilt"; \
+			--enable-ldiskfs"; \
 	else \
 		export EXTRAFLAGS="$${EXTRAFLAGS} \
-			--disable-ldiskfs --disable-quilt"; \
+			--disable-ldiskfs"; \
 	fi; \
 	if echo "$${DEB_BUILD_PROFILES}" | grep -q "multiple-lnds"; then \
 		export EXTRAFLAGS="$${EXTRAFLAGS} --enable-multiple-lnds"; \
diff --git a/ldiskfs/README b/ldiskfs/README
index 8df479b8f1..74bceb8e56 100644
--- a/ldiskfs/README
+++ b/ldiskfs/README
@@ -60,9 +60,19 @@ would copy the patch to:
 
   patches/rhel6.4/foo.patch
 
-The next step would be to edit series/ldiskfs-2.6-rhel6.4.series to point
-to the new patch.  Finally, the developer may edit files and "quilt refresh"
-the new patch.
+The next step would be to create a new patch file containing your changes.
+You can do this by generating a diff between the original and modified files:
+
+  diff -u original_file modified_file > new_patch.patch
+
+Once you have created your patch file, you can add it to your series file
+(e.g. series/ldiskfs-2.6-rhel6.4.series) by adding the patch filename
+to the list. To apply the patch later, you can use the patch command:
+
+  patch < new_patch.patch
+
+If you need to make further changes, edit the files directly and then
+regenerate the patch file using the diff command as shown above.
 
 Detecting which patch series to apply
 -------------------------------------
diff --git a/ldiskfs/autoMakefile.am b/ldiskfs/autoMakefile.am
index 9644063d43..3e5abf3e0c 100644
--- a/ldiskfs/autoMakefile.am
+++ b/ldiskfs/autoMakefile.am
@@ -57,18 +57,12 @@ sources: $(backfs_sources) $(backfs_headers) $(linux_headers) $(uapi_linux_heade
 	if test -n "$(trace_headers)" ; then \
 		cp $(trace_headers) linux-stage/include/trace/events; \
 	fi
-if USE_QUILT
-	ln -s ../$(patches) linux-stage/patches
-	ln -s ../$(series) linux-stage/series
-	cd linux-stage && quilt push -a -q
-else
 	@echo -n "Applying ext4 patches:"
 	@cd linux-stage && for i in $$(<../$(series)) ; do \
 		echo -n " $$i" ; \
 		patch -s -p1 < ../$(patches)/$$i || exit 1 ; \
 	done
 	@echo
-endif
 	mkdir -p uapi/linux linux trace/events
 	@echo -n "Replacing 'ext4' with 'ldiskfs':"
 	for i in $(notdir $(backfs_headers) $(backfs_sources)) $(new_sources) ; do \

</pre>
</body>
</html>
