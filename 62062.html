<html lang="en">
<body>
<pre>
From e523a117c9f2688a6ada10ddff66ca302cca177c Mon Sep 17 00:00:00 2001
From: Serguei Smirnov <ssmirnov@whamcloud.com>
Date: Mon, 27 Oct 2025 12:54:38 -0700
Subject: [PATCH 1/1] LU-19528 lnet: restore kernel cb before listener sk free

Restore kernel callback before listener socket is freed.
Otherwise a late interrupt can occur during the teardown
and cause a crash due to __wake_up_common on NULL.

Test-Parameters: trivial testlist=sanity-lnet
Fixes: 2e49bc7dd17 ("LU-18812 lnet: restrict IP addresses")
Signed-off-by: Serguei Smirnov <ssmirnov@whamcloud.com>
Change-Id: If87545d4f3ad30ab1f37b4d38a9c49a25557aca5
---
 lnet/lnet/acceptor.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

diff --git a/lnet/lnet/acceptor.c b/lnet/lnet/acceptor.c
index eb85643b84..0b38a8ee03 100644
--- a/lnet/lnet/acceptor.c
+++ b/lnet/lnet/acceptor.c
@@ -573,6 +573,12 @@ lnet_acceptor(void *arg)
 					cfs_time_seconds(1));
 				}
 				if (atomic_dec_and_test(&lsock->refcnt)) {
+					/* publish restore before release */
+					if (lsock->liss_sock && lsock->liss_sock->sk) {
+						WRITE_ONCE(lsock->liss_sock->sk->sk_data_ready,
+							   lnet_acceptor_state.pta_odata);
+						smp_wmb();
+					}
 					sock_release(lsock->liss_sock);
 					kfree(lsock);
 				}
@@ -612,6 +618,12 @@ lnet_acceptor(void *arg)
 				goto failed;
 
 			if (atomic_dec_and_test(&lsock->refcnt)) {
+				/* publish restore before release */
+				if (lsock->liss_sock && lsock->liss_sock->sk) {
+					WRITE_ONCE(lsock->liss_sock->sk->sk_data_ready,
+						   lnet_acceptor_state.pta_odata);
+					smp_wmb();
+				}
 				sock_release(lsock->liss_sock);
 				kfree(lsock);
 			}
@@ -623,6 +635,12 @@ failed:
 				newsock = NULL;
 			}
 			if (atomic_dec_and_test(&lsock->refcnt)) {
+				/* publish restore before release */
+				if (lsock->liss_sock && lsock->liss_sock->sk) {
+					WRITE_ONCE(lsock->liss_sock->sk->sk_data_ready,
+						   lnet_acceptor_state.pta_odata);
+					smp_wmb();
+				}
 				sock_release(lsock->liss_sock);
 				kfree(lsock);
 			}

</pre>
</body>
</html>
