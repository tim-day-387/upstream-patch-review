From 9e6329b2a4d4b491931d128c1f058a25eb49a21b Mon Sep 17 00:00:00 2001
From: Arshad Hussain <arshad.hussain@aeoncomputing.com>
Date: Fri, 24 Oct 2025 04:19:03 -0400
Subject: [PATCH 1/1] LU-19524 llite: correctly free mem if copy_from_user
 fails

memory allocated from ll_prep_md_op_data call is left dangling
if copy_from_user() fails. This patch fixes this by jumping to
label out where it is correctly reclaimed vs just returning.

Test-Parameters: trivial
Signed-off-by: Arshad Hussain <arshad.hussain@aeoncomputing.com>
Change-Id: I7314c36a8678ed1cf74b5adf8b60433f8b8efb43
---
 lustre/llite/file.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lustre/llite/file.c b/lustre/llite/file.c
index 6cceaf2ab9..3a72d977fa 100644
--- a/lustre/llite/file.c
+++ b/lustre/llite/file.c
@@ -1600,7 +1600,7 @@ static int ll_lease_file_resync(struct obd_client_handle *och,
 		RETURN(PTR_ERR(op_data));
 
 	if (copy_from_user(&ioc, uarg, sizeof(ioc)))
-		RETURN(-EFAULT);
+		GOTO(out, rc = -EFAULT);
 
 	/* before starting file resync, it's necessary to clean up page cache
 	 * in client memory, otherwise once the layout version is increased,
