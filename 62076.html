<html lang="en">
<body>
<pre>
From 4f4ac76f9189aea7c6532e7a552274d1eecd54d1 Mon Sep 17 00:00:00 2001
From: Patrick Farrell <pfarrell@whamcloud.com>
Date: Wed, 29 Oct 2025 18:40:19 -0400
Subject: [PATCH 1/1] LU-19533 tests: add EC FLR state transition test

Add test_2 to sanity-ec.sh to verify EC file FLR state
transitions. The test creates an EC file with data and
parity mirrors, then verifies state changes from RDONLY
to WRITE_PENDING after writes, and back to RDONLY after
resync. Tests writes to multiple components to ensure
proper stale flag handling.

Also adds helper functions verify_flr_state() and
verify_comp_stale() for EC FLR state verification.

Test-Parameters: forjanitoronly
Signed-off-by: Patrick Farrell <pfarrell@whamcloud.com>
Change-Id: I92914c86759f293f4ccc6bd36a281e88d08216cb
---
 lustre/tests/Makefile.am  |  1 +
 lustre/tests/sanity-ec.sh | 71 +++++++++++++++++++++++++++++++++++++++
 2 files changed, 72 insertions(+)

diff --git a/lustre/tests/Makefile.am b/lustre/tests/Makefile.am
index 9ededb0b35..d653c60997 100644
--- a/lustre/tests/Makefile.am
+++ b/lustre/tests/Makefile.am
@@ -40,6 +40,7 @@ noinst_SCRIPTS += posix.sh sanity-scrub.sh scrub-performance.sh ha.sh pjdfstest.
 noinst_SCRIPTS += sanity-lfsck.sh lfsck-performance.sh
 noinst_SCRIPTS += sanity-hsm.sh sanity-lsnapshot.sh sanity-pfl.sh sanity-flr.sh
 noinst_SCRIPTS += sanity-dom.sh sanity-pcc.sh dom-performance.sh sanity-lnet.sh
+noinst_SCRIPTS += sanity-ec.sh
 nobase_noinst_SCRIPTS = cfg/local.sh
 nobase_noinst_SCRIPTS += test-groups/regression test-groups/regression-mpi
 nobase_noinst_SCRIPTS += acl/make-tree acl/run cfg/ncli.sh
diff --git a/lustre/tests/sanity-ec.sh b/lustre/tests/sanity-ec.sh
index c23685e900..634e7813ee 100644
--- a/lustre/tests/sanity-ec.sh
+++ b/lustre/tests/sanity-ec.sh
@@ -342,6 +342,77 @@ test_1f() {
 }
 run_test 1f "setstripe with different parity counts"
 
+test_2() {
+	local tf=$DIR/$tfile
+
+	stack_trap "rm -f $tf"
+
+	# Create EC file with lfs setstripe
+	# Layout: Mirror 1 has 3 data components [0,128M], [128M,1G], [1G,EOF]
+	#         Mirror 2 has 3 EC components at same extents
+	$LFS setstripe -E 128M -E 1G -E -1 --ec 4+2 $tf ||
+		error "setstripe failed"
+
+	# Verify file starts in RDONLY state
+	verify_flr_state $tf "ro"
+
+	# Get component IDs for both mirrors
+	local ids=($($LFS getstripe $tf | awk '/lcme_id/{print $2}' |
+			tr '\n' ' '))
+	echo "Component IDs: ${ids[@]}"
+
+	# Write to first component (0-1M, within [0,128M] extent)
+	dd if=/dev/zero of=$tf conv=notrunc bs=1M count=1 ||
+		error "write to first component failed"
+
+	# Verify file is now in WRITE_PENDING state
+	verify_flr_state $tf "wp"
+
+	# Verify the corresponding EC component in mirror 2 is stale
+	# Mirror 1 components are ids[0], ids[1], ids[2]
+	# Mirror 2 components are ids[3], ids[4], ids[5]
+	# After writing to first component, ids[3] should be stale
+	verify_comp_stale $tf ${ids[3]}
+
+	# Resync the file
+	$LFS mirror resync $tf || error "mirror resync failed"
+
+	# Verify file is back to RDONLY state
+	verify_flr_state $tf "ro"
+
+	# Verify component is no longer stale
+	local flags=$($LFS getstripe -I${ids[3]} $tf |
+			awk '/lcme_flags:/ { print $2 }')
+	[[ ! $flags =~ "stale" ]] ||
+		error "component ${ids[3]} still stale after resync: $flags"
+
+	echo "** Write to second component **"
+
+	# Write to second component (at offset 256M, within [128M,1G] extent)
+	dd if=/dev/zero of=$tf conv=notrunc bs=1M count=1 seek=256 ||
+		error "write to second component failed"
+
+	# Verify file is in WRITE_PENDING state
+	verify_flr_state $tf "wp"
+
+	# Verify the corresponding EC component in mirror 2 is stale
+	# ids[4] is the second EC component
+	verify_comp_stale $tf ${ids[4]}
+
+	# Resync the file
+	$LFS mirror resync $tf || error "mirror resync failed"
+
+	# Verify file is back to RDONLY state
+	verify_flr_state $tf "ro"
+
+	# Verify component is no longer stale
+	flags=$($LFS getstripe -I${ids[4]} $tf |
+			awk '/lcme_flags:/ { print $2 }')
+	[[ ! $flags =~ "stale" ]] ||
+		error "component ${ids[4]} still stale after resync: $flags"
+}
+run_test 2 "EC FLR state transitions with writes to different components"
+
 complete_test $SECONDS
 check_and_cleanup_lustre
 exit_status

</pre>
</body>
</html>
