<html lang="en">
<body>
<pre>
From d2463b614a307446ef20d072b39485301bc5553a Mon Sep 17 00:00:00 2001
From: Patrick Farrell <pfarrell@whamcloud.com>
Date: Fri, 24 Oct 2025 17:01:09 -0400
Subject: [PATCH 1/1] LU-19519 lod: allow migration of PFL with invalid OST

For uninitialized PFL components, the stripe offset
may be invalid (e.g., pointing to a deactivated OST).
This can happen during migration when old layouts have
deprecated stripe offsets stored in lmm_layout_gen.

Previously, lod_ost_alloc_specific() would fail with
-EINVAL when it could not find the specified OST in
the pool, blocking migration with "cannot get group
lock" errors.

This patch modifies lod_ost_alloc_specific() to detect
uninitialized components with invalid stripe offsets,
reset the offset to LOV_OFFSET_DEFAULT, and return
-EAGAIN to trigger fallback to QoS or round-robin
allocation.

The corresponding fallback logic is added to
lod_qos_prep_create() to handle -EAGAIN by attempting
QoS allocation first, then round-robin if needed.

A test case is added to verify that migration succeeds
for PFL files with uninitialized components on
deactivated OSTs.

Signed-off-by: Patrick Farrell <pfarrell@whamcloud.com>
Change-Id: Ie276a1094dfb2df18100ec1cffc72d791587c847
---
 lustre/lod/lod_qos.c       | 29 ++++++++++++++++
 lustre/tests/sanity-pfl.sh | 69 ++++++++++++++++++++++++++++++++++++++
 2 files changed, 98 insertions(+)

diff --git a/lustre/lod/lod_qos.c b/lustre/lod/lod_qos.c
index 975f720758..f7a47353bc 100644
--- a/lustre/lod/lod_qos.c
+++ b/lustre/lod/lod_qos.c
@@ -1284,6 +1284,20 @@ repeat_find:
 		}
 	}
 	if (i == ost_count) {
+		/*
+		 * For uninitialized PFL components, the stripe offset may be
+		 * invalid (e.g., pointing to a deactivated OST). In this case,
+		 * fall back to QoS allocation instead of failing. This can
+		 * happen during migration when old layouts have deprecated
+		 * stripe offsets stored in lmm_layout_gen.
+		 */
+		if (!lod_comp_inited(lod_comp)) {
+			CDEBUG(D_LAYOUT,
+			       "Uninitialized component %d has invalid start index %d, using QoS allocation\n",
+			       comp_idx, lod_comp->llc_stripe_offset);
+			lod_comp->llc_stripe_offset = LOV_OFFSET_DEFAULT;
+			GOTO(out, rc = -EAGAIN);
+		}
 		CERROR("Start index %d not found in pool '%s'\n",
 		       lod_comp->llc_stripe_offset,
 		       lod_comp->llc_pool ? lod_comp->llc_pool : "");
@@ -2883,6 +2897,21 @@ repeat:
 			rc = lod_ost_alloc_specific(env, lo, stripe,
 						    ost_indices, flags, th,
 						    comp_idx, reserve);
+			/*
+			 * For uninitialized components with invalid stripe
+			 * offset, fall back to QoS allocation
+			 */
+			if (rc == -EAGAIN) {
+				rc = lod_ost_alloc_qos(env, lo, stripe,
+						       ost_indices, flags, th,
+						       comp_idx, reserve);
+				if (rc == -EAGAIN)
+					rc = lod_ost_alloc_rr(env, lo, stripe,
+							      ost_indices,
+							      flags, th,
+							      comp_idx,
+							      reserve);
+			}
 		}
 put_ldts:
 		lod_putref(d, &d->lod_ost_descs);
diff --git a/lustre/tests/sanity-pfl.sh b/lustre/tests/sanity-pfl.sh
index 6d220858dc..b3fe060de7 100755
--- a/lustre/tests/sanity-pfl.sh
+++ b/lustre/tests/sanity-pfl.sh
@@ -2625,6 +2625,75 @@ test_27() {
 }
 run_test 27 "overstriping with -C -1 in mdt_dump_lmm"
 
+test_28() { # LU-19519
+	[ $OSTCOUNT -lt 2 ] && skip "needs >= 2 OSTs"
+
+	local file=$DIR/$tdir/$tfile
+	local pool="testpool"
+
+	test_mkdir -p $DIR/$tdir
+	stack_trap "rm -f $file"
+
+	# Create a pool with OST0 and OST1
+	pool_add $pool || error "pool_add $pool failed"
+	stack_trap "destroy_test_pools"
+	pool_add_targets $pool 0 1 || error "pool_add_targets failed"
+
+	# Create a PFL file with two components using explicit OST indices:
+	# - First component: 0-1M, will be instantiated on OST0
+	# - Second component: 1M-EOF, will remain uninitialized on OST1
+	$LFS setstripe -E 1M -c 1 -i 0 -p $pool \
+		       -E -1 -c 1 -i 1 -p $pool $file ||
+		error "create PFL file $file failed"
+
+	# Write some data to first component only (512K, within 1M boundary)
+	dd if=/dev/zero of=$file bs=512K count=1 conv=notrunc ||
+		error "write to $file failed"
+
+	# Verify layout: first component should be init, second should not
+	local comp1_flags=$($LFS getstripe -I1 --component-flags $file)
+	local comp2_flags=$($LFS getstripe -I2 --component-flags $file)
+
+	[[ "$comp1_flags" == "init" ]] ||
+		error "component 1 should be init, got: $comp1_flags"
+	[[ "$comp2_flags" == "0" ]] ||
+		error "component 2 should be uninit (0), got: $comp2_flags"
+
+	# Get the stripe offset of the uninitialized component
+	local comp2_ost=$($LFS getstripe -I2 -i $file)
+	echo "Uninitialized component 2 has stripe offset: $comp2_ost"
+	[[ $comp2_ost -eq 1 ]] ||
+		error "expected comp2 on OST1, got OST$comp2_ost"
+
+	# Now remove OST1 from the pool, making the uninitialized
+	# component's stripe offset invalid for the pool
+	pool_remove_target $pool 1 ||
+		error "pool_remove_target $pool 1 failed"
+
+	# Verify the pool no longer contains OST1
+	local pool_osts=$(do_facet mds1 $LCTL pool_list $FSNAME.$pool |
+			  grep "^$FSNAME-OST")
+	echo "Pool now contains: $pool_osts"
+	[[ "$pool_osts" =~ "OST0001" ]] &&
+		error "pool should not contain OST1"
+
+	# Now try to migrate the file - this should succeed with the fix
+	# The uninitialized component with invalid stripe offset should not
+	# block migration
+	$LFS migrate -c 1 $file || error "migrate $file failed"
+
+	# Verify the file is now a plain layout (component count should be 0)
+	local comp_count=$($LFS getstripe --component-count $file)
+	[[ $comp_count -eq 0 ]] ||
+		error "expected plain layout, got $comp_count components"
+
+	# Verify data integrity
+	local size=$(stat -c%s $file)
+	[[ $size -eq 524288 ]] ||
+		error "file size changed: expected 524288, got $size"
+}
+run_test 28 "migrate PFL file with uninitialized component on invalid OST"
+
 complete_test $SECONDS
 check_and_cleanup_lustre
 exit_status

</pre>
</body>
</html>
