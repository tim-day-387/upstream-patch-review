From a3bb8d379ab31855351966a21926b76df108a306 Mon Sep 17 00:00:00 2001
From: Patrick Farrell <pfarrell@whamcloud.com>
Date: Tue, 28 Oct 2025 14:26:26 -0400
Subject: [PATCH 1/1] LU-19533 ec: block prefer flags on parity components

Parity components in EC mirrors should not have prefer
flags (LCME_FL_PREF_RW, LCME_FL_PREF_RD, LCME_FL_PREF_WR)
set on them, as they are not meant to be used for normal
I/O operations.

Additionally, non-parity components in parity-containing
mirrors can only have LCME_FL_PREF_RD set, not
LCME_FL_PREF_WR or LCME_FL_PREF_RW.

This patch adds:
- Client-side validation in lfs_component_set() to provide
  user-friendly error messages
- Server-side enforcement in lod_declare_layout_set() to
  prevent setting these flags
- Test coverage in sanity-ec.sh test_4

Signed-off-by: Patrick Farrell <pfarrell@whamcloud.com>
Change-Id: I294b6074f2891e964a35f3209636c9369a4287fa
---
 lustre/lod/lod_object.c   |  80 ++++++++++++++++++++++--------
 lustre/tests/sanity-ec.sh |  55 ++++++++++++++++++++
 lustre/utils/lfs.c        | 102 ++++++++++++++++++++++++++++++++++++++
 3 files changed, 215 insertions(+), 22 deletions(-)

diff --git a/lustre/lod/lod_object.c b/lustre/lod/lod_object.c
index 54db7fd81c..76249f01e2 100644
--- a/lustre/lod/lod_object.c
+++ b/lustre/lod/lod_object.c
@@ -2967,6 +2967,28 @@ bool lod_last_non_stale_mirror(__u16 mirror_id, struct lod_object *lo)
 	return true;
 }
 
+/**
+ * lod_mirror_has_parity() - Check if a mirror has any parity components.
+ * @lo: object
+ * @mirror_idx: mirror index
+ *
+ * Return:
+ * * %true if mirror has parity components
+ * * %false otherwise
+ */
+static inline
+bool lod_mirror_has_parity(struct lod_object *lo, int mirror_idx)
+{
+	struct lod_layout_component *lod_comp;
+
+	lod_foreach_mirror_comp(lod_comp, lo, mirror_idx) {
+		if (lod_comp->llc_flags & LCME_FL_PARITY)
+			return true;
+	}
+
+	return false;
+}
+
 /**
  * lod_declare_layout_set() - Declare component set
  * @env: execution environment
@@ -3063,6 +3085,42 @@ static int lod_declare_layout_set(const struct lu_env *env,
 							&lo->ldo_layout_mutex);
 						RETURN(-EUCLEAN);
 					}
+					/* parity components cannot have any
+					 * prefer flags set
+					 */
+					if ((flags & LCME_FL_PREF_RW) &&
+					    (lod_comp->llc_flags &
+					     LCME_FL_PARITY)) {
+						mutex_unlock(
+							&lo->ldo_layout_mutex);
+						RETURN(-EINVAL);
+					}
+					/* non-parity components in parity
+					 * mirrors can only have PREF_RD
+					 */
+					if ((flags & (LCME_FL_PREF_WR |
+						      LCME_FL_PREF_RW)) &&
+					    !(lod_comp->llc_flags &
+					      LCME_FL_PARITY)) {
+						int k;
+						__u16 comp_mirror_id =
+							mirror_id_of(lod_comp->llc_id);
+
+						/* find mirror index from ID */
+						for (k = 0; k < lo->ldo_mirror_count;
+						     k++) {
+							if (lo->ldo_mirrors[k].lme_id ==
+							    comp_mirror_id)
+								break;
+						}
+
+						if (k < lo->ldo_mirror_count &&
+						    lod_mirror_has_parity(lo, k)) {
+							mutex_unlock(
+								&lo->ldo_layout_mutex);
+							RETURN(-EINVAL);
+						}
+					}
 					lod_comp->llc_flags |= flags;
 				}
 				if (mirror_flag) {
@@ -7764,28 +7822,6 @@ static inline int lod_check_ost_avail(const struct lu_env *env,
 	return 1;
 }
 
-/**
- * lod_mirror_has_parity() - Check if a mirror has any parity components.
- * @lo: object
- * @mirror_idx: mirror index
- *
- * Return:
- * * %true if mirror has parity components
- * * %false otherwise
- */
-static inline
-bool lod_mirror_has_parity(struct lod_object *lo, int mirror_idx)
-{
-	struct lod_layout_component *lod_comp;
-
-	lod_foreach_mirror_comp(lod_comp, lo, mirror_idx) {
-		if (lod_comp->llc_flags & LCME_FL_PARITY)
-			return true;
-	}
-
-	return false;
-}
-
 /**
  * lod_primary_pick() - Pick primary mirror for write
  * @env: execution environment
diff --git a/lustre/tests/sanity-ec.sh b/lustre/tests/sanity-ec.sh
index a86638a3eb..24a088dfc4 100755
--- a/lustre/tests/sanity-ec.sh
+++ b/lustre/tests/sanity-ec.sh
@@ -290,6 +290,61 @@ test_3() {
 }
 run_test 3 "EC mirror read/write commands (adapted from sanity-flr test_0j)"
 
+test_4() {
+	local tf=$DIR/$tfile
+	local ec_create=$LUSTRE/../ec_create_simple
+
+	[[ -x $ec_create ]] ||
+		skip "ec_create_simple not found or not executable"
+
+	# Create EC file with ec_create_simple
+	$ec_create $tf || error "ec_create_simple failed"
+
+	# Get component IDs - use hex format as lfs expects
+	local data_comp1=0x10001
+	local data_comp2=0x10002
+	local parity_comp1=0x20004
+
+	# Test 1: Cannot set prefer on parity component
+	$LFS setstripe --comp-set -I $parity_comp1 --comp-flags=prefer \
+		$tf 2>&1 | grep -q "cannot set prefer flags on parity component" ||
+		error "should not allow prefer on parity component"
+
+	# Test 2: Cannot set prefrd on parity component
+	$LFS setstripe --comp-set -I $parity_comp1 --comp-flags=prefrd \
+		$tf 2>&1 | grep -q "cannot set prefer flags on parity component" ||
+		error "should not allow prefrd on parity component"
+
+	# Test 3: Cannot set prefwr on parity component
+	$LFS setstripe --comp-set -I $parity_comp1 --comp-flags=prefwr \
+		$tf 2>&1 | grep -q "cannot set prefer flags on parity component" ||
+		error "should not allow prefwr on parity component"
+
+	# Test 4: Can set prefwr on data component in data mirror
+	$LFS setstripe --comp-set -I $data_comp1 --comp-flags=prefwr \
+		$tf || error "should allow prefwr on data component"
+	$LFS getstripe $tf | grep -A3 "lcme_id:.*65537" |
+		grep -q "prefwr" ||
+		error "prefwr flag not set on data component"
+
+	# Test 5: Can set prefer on data component in data mirror
+	$LFS setstripe --comp-set -I $data_comp2 --comp-flags=prefer \
+		$tf || error "should allow prefer on data component"
+	$LFS getstripe $tf | grep -A3 "lcme_id:.*65538" |
+		grep -q "prefer" ||
+		error "prefer flag not set on data component"
+
+	# Test 6: Can set prefrd on data component in data mirror
+	$LFS setstripe --comp-set -I $data_comp1 --comp-flags=^prefwr \
+		$tf || error "failed to clear prefwr"
+	$LFS setstripe --comp-set -I $data_comp1 --comp-flags=prefrd \
+		$tf || error "should allow prefrd on data component"
+	$LFS getstripe $tf | grep -A3 "lcme_id:.*65537" |
+		grep -q "prefrd" ||
+		error "prefrd flag not set on data component"
+}
+run_test 4 "Block setting prefer flags on parity components"
+
 complete_test $SECONDS
 check_and_cleanup_lustre
 exit_status
diff --git a/lustre/utils/lfs.c b/lustre/utils/lfs.c
index 8c14df74f7..0db4ac14c0 100644
--- a/lustre/utils/lfs.c
+++ b/lustre/utils/lfs.c
@@ -1262,6 +1262,108 @@ static int lfs_component_set(char *fname, int comp_id, const char *pool,
 	}
 
 	if (flags) {
+		/* Check if trying to set prefer flags on parity components */
+		if (flags & LCME_FL_PREF_RW) {
+			struct llapi_layout *layout;
+			__u32 comp_flags = 0;
+			__u32 id;
+			__u32 mirror_id;
+			bool is_parity_comp = false;
+			bool is_parity_mirror = false;
+
+			layout = llapi_layout_get_by_path(fname, 0);
+			if (!layout) {
+				fprintf(stderr,
+					"error %s: file '%s' couldn't get layout: rc=%d\n",
+					progname, fname, errno);
+				return -errno;
+			}
+
+			/* Find the component and check its flags */
+			rc = llapi_layout_comp_use(layout,
+						   LLAPI_LAYOUT_COMP_USE_FIRST);
+			while (rc == 0) {
+				rc = llapi_layout_comp_id_get(layout, &id);
+				if (rc < 0)
+					break;
+
+				if (id == comp_id) {
+					rc = llapi_layout_comp_flags_get(layout,
+								&comp_flags);
+					if (rc < 0)
+						break;
+
+					rc = llapi_layout_mirror_id_get(layout,
+								&mirror_id);
+					if (rc < 0)
+						break;
+
+					is_parity_comp = !!(comp_flags &
+							    LCME_FL_PARITY);
+
+					/* Check if any component in this mirror
+					 * has parity flag
+					 */
+					if (!is_parity_comp) {
+						int tmp_rc;
+						__u32 tmp_mirror_id;
+						__u32 tmp_flags;
+
+						tmp_rc = llapi_layout_comp_use(
+							layout,
+							LLAPI_LAYOUT_COMP_USE_FIRST);
+						while (tmp_rc == 0) {
+							tmp_rc = llapi_layout_mirror_id_get(
+								layout,
+								&tmp_mirror_id);
+							if (tmp_rc < 0)
+								break;
+
+							if (tmp_mirror_id ==
+							    mirror_id) {
+								tmp_rc = llapi_layout_comp_flags_get(
+									layout,
+									&tmp_flags);
+								if (tmp_rc < 0)
+									break;
+
+								if (tmp_flags &
+								    LCME_FL_PARITY) {
+									is_parity_mirror = true;
+									break;
+								}
+							}
+
+							tmp_rc = llapi_layout_comp_use(
+								layout,
+								LLAPI_LAYOUT_COMP_USE_NEXT);
+						}
+					}
+					break;
+				}
+
+				rc = llapi_layout_comp_use(layout,
+						LLAPI_LAYOUT_COMP_USE_NEXT);
+			}
+
+			llapi_layout_free(layout);
+
+			if (is_parity_comp) {
+				fprintf(stderr,
+					"%s: cannot set prefer flags on parity component '%#x' of file '%s'\n",
+					progname, comp_id, fname);
+				return -EINVAL;
+			}
+
+			if (is_parity_mirror &&
+			    (flags & (LCME_FL_PREF_WR | LCME_FL_PREF_RW))) {
+				fprintf(stderr,
+					"%s: cannot set 'prefwr' or 'prefer' flags on non-parity component '%#x' in parity mirror of file '%s'\n",
+					progname, comp_id, fname);
+				return -EINVAL;
+			}
+		}
+
 		ids[count] = comp_id;
 		flags_array[count] = flags;
 		++count;
