From 12cea2c0f58eea322797d5e4a8adf8285ad954e3 Mon Sep 17 00:00:00 2001
From: Aryan Gupta <argupta@ddn.com>
Date: Thu, 10 Jul 2025 03:00:38 -0400
Subject: [PATCH 1/1] LU-14469 lmv: use OBD_ALLOC_LARGE() in lmv_rmfid()

Standardize memory allocation and deallocation in lmv_rmfid():

- Replace standard allocations with OBD_ALLOC_PTR_ARRAY_LARGE()
  and OBD_ALLOC_LARGE()
- Remove redundant NULL checks before memory deallocation
- Move ptlrpc_set_destroy() after the out: label to ensure proper
  cleanup on early exit

This change improves code consistency and ensure proper resource
cleanup in all code paths.

Signed-off-by: Aryan Gupta <argupta@ddn.com>
Change-Id: I155d802901bac5f00c88dbcbf8073d701e2a6537
---
 lustre/lmv/lmv_obd.c | 48 ++++++++++++++++++++++----------------------
 1 file changed, 24 insertions(+), 24 deletions(-)

diff --git a/lustre/lmv/lmv_obd.c b/lustre/lmv/lmv_obd.c
index 295dd71a5b..f01781d87f 100644
--- a/lustre/lmv/lmv_obd.c
+++ b/lustre/lmv/lmv_obd.c
@@ -3502,10 +3502,11 @@ static int lmv_rmfid(struct obd_export *exp, struct fid_array *fa,
 	}
 
 	/* split FIDs by targets */
-	OBD_ALLOC_PTR_ARRAY(fas, tgt_count);
+	OBD_ALLOC_PTR_ARRAY_LARGE(fas, tgt_count);
 	if (fas == NULL)
 		GOTO(out, rc = -ENOMEM);
-	OBD_ALLOC_PTR_ARRAY(rcs, tgt_count);
+
+	OBD_ALLOC_PTR_ARRAY_LARGE(rcs, tgt_count);
 	if (rcs == NULL)
 		GOTO(out_fas, rc = -ENOMEM);
 
@@ -3519,15 +3520,17 @@ static int lmv_rmfid(struct obd_export *exp, struct fid_array *fa,
 			continue;
 		}
 		LASSERT(idx < tgt_count);
-		if (!fas[idx])
-			OBD_ALLOC(fas[idx], offsetof(struct fid_array,
-				  fa_fids[fa->fa_nr]));
-		if (!fas[idx])
-			GOTO(out, rc = -ENOMEM);
-		if (!rcs[idx])
-			OBD_ALLOC_PTR_ARRAY(rcs[idx], fa->fa_nr);
-		if (!rcs[idx])
-			GOTO(out, rc = -ENOMEM);
+		if (!fas[idx]) {
+			OBD_ALLOC_LARGE(fas[idx], offsetof(struct fid_array,
+							fa_fids[fa->fa_nr]));
+			if (!fas[idx])
+				GOTO(out_rcs, rc = -ENOMEM);
+		}
+		if (!rcs[idx]) {
+			OBD_ALLOC_PTR_ARRAY_LARGE(rcs[idx], fa->fa_nr);
+			if (!rcs[idx])
+				GOTO(out_rcs, rc = -ENOMEM);
+		}
 
 		fat = fas[idx];
 		fat->fa_fids[fat->fa_nr++] = fa->fa_fids[i];
@@ -3556,22 +3559,19 @@ static int lmv_rmfid(struct obd_export *exp, struct fid_array *fa,
 			j += fat->fa_nr;
 		}
 	}
-	if (set != _set)
-		ptlrpc_set_destroy(set);
 
-out:
 	for (i = 0; i < tgt_count; i++) {
-		if (fas && fas[i])
-			OBD_FREE(fas[i], offsetof(struct fid_array,
-						fa_fids[fa->fa_nr]));
-		if (rcs && rcs[i])
-			OBD_FREE_PTR_ARRAY(rcs[i], fa->fa_nr);
-	}
-	if (rcs)
-		OBD_FREE_PTR_ARRAY(rcs, tgt_count);
+		OBD_FREE_LARGE(fas[i], offsetof(struct fid_array,
+							fa_fids[fa->fa_nr]));
+		OBD_FREE_PTR_ARRAY_LARGE(rcs[i], fa->fa_nr);
+	}
+out_rcs:
+	OBD_FREE_PTR_ARRAY_LARGE(rcs, tgt_count);
 out_fas:
-	if (fas)
-		OBD_FREE_PTR_ARRAY(fas, tgt_count);
+	OBD_FREE_PTR_ARRAY_LARGE(fas, tgt_count);
+out:
+	if (set != _set)
+		ptlrpc_set_destroy(set);
 
 	RETURN(rc);
 }
