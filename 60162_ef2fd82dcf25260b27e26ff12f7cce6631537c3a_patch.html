<html lang="en">
<body>
<pre>
LU-11509 ldlm: replace client lock LRU with LFRU

This commit introduces a tailored version of the LFRU (Least
Frequently and Recently Used) algorithm to improve cache
management. The goal is to ensure that high-priority locks are
more likely to remain in the cache.

Original LFRU - "A Cache Management Scheme for Efficient Content
Eviction and Replication in Cache Networks":
- It promotes items with relatively high access counts in a recent
  time window into a privileged list (managed by LRU), while less
  active items stay in a normal list. Two dynamically changing
  thresholds act as gates:
  > min gate controls admission to the normal list,
  > max gate controls promotion to the privileged list,
both based on observed per-item access frequencies within the window.

Our implementation retains this two-list structure with customization
for performance and simplicity:

1. Admission policy
- All new locks enter the normal list directly.
- The 'min gate' is removed.
2. Promotion threshold
- Instead of an access-count container over a sliding window, we
track a simple max_freq representing the highest observed access
rate in the current window.
- priv_threshold is updated in two cases:
  > Immediately, if a new lock's frequency exceeds it; in this
    case, max_freq is reset to the default(=1) value, so it can
    track subsequent effective access counts rather than growing
    unbounded.
  > Periodically, using the max_freq collected from the recent
    window.
- This reduces bookkeeping overhead while still identifying
  "important" elements for promotion.
3. Eviction policy
- The privileged list uses LRU, as in the original scheme.
- The normal list continues to use our existing eviction strategy
  (aged/LRUR), avoiding unnecessary complexity.

Performance Gains
We made up a customized test on MDC for performance test (see
sanity_124g for details, 10s of `stats` followed by a `ls -l`), and
it shows a reduction in enqueue requests for prioritized items.
Besides in random workloads (15s in racer_test_1) there's no perf
degradation.

Test Scenario	LFRU (avg reqs)	Current LRU (avg)	Improvement
Customized(MDC)	9655		12710			~20% fewer
Random		36757		36783		        No degration

Possible Cons
Less important locks that in normal list are more likely to be
evicted as a capacity reservation of up to 30% is allocated to
the privileged list, leaving the rest 70% for normal list.

Brief on Code Change
An abstraction layer `ldlm_lock_cache_policy` is introduced,
and the corresponding LRU/LFRU implementations are added in
lock_cache_policy.c. LFRU is the default policy now.

To switch between LRU/LFRU, we could use commands,
lctl set_param $ldlm-mdc-namespace.lock_cache_policy=LFRU

Signed-off-by: Keguang Xu <squalfof@gmail.com>
Change-Id: Ida3df854348c8a7268834ebcdad4afaa9c645e0d

</pre>
</body>
</html>
