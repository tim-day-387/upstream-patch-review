<html lang="en">
<body>
<pre>
From 1eda148d79c88aeabe4f05f822e8f0cc337c2261 Mon Sep 17 00:00:00 2001
From: Shaun Tancheff <shaun.tancheff@hpe.com>
Date: Sun, 26 Oct 2025 14:53:45 +0800
Subject: [PATCH 1/1] LU-19514 compat: make kallsyms_lookup_name() optional

If kallsyms_lookup_name is not available for any reason Lustre
can still function correctly.

Test-Parameters: trivial
Fixes: b18bfc7c793 ("LU-18687 compat: improve cfs_kallsyms_lookup_name()")
Signed-off-by: Shaun Tancheff <shaun.tancheff@hpe.com>
Change-Id: I05f51364db8ddecea800358140e3b04fff5a51fb
---
 lustre_compat/symbols.c | 32 +++++++++++++++++++++++++-------
 1 file changed, 25 insertions(+), 7 deletions(-)

diff --git a/lustre_compat/symbols.c b/lustre_compat/symbols.c
index 74acda294a..e29c8dc6cf 100644
--- a/lustre_compat/symbols.c
+++ b/lustre_compat/symbols.c
@@ -18,6 +18,8 @@ static void *(*__cfs_kallsyms_lookup_name)(const char *name);
 
 void *cfs_kallsyms_lookup_name(const char *name)
 {
+	if (!__cfs_kallsyms_lookup_name)
+		return NULL;
 	return __cfs_kallsyms_lookup_name(name);
 }
 EXPORT_SYMBOL_GPL(cfs_kallsyms_lookup_name);
@@ -32,6 +34,7 @@ static int find_kallsyms_lookup_name(void)
 #else
 static int find_kallsyms_lookup_name(void)
 {
+#ifdef CONFIG_KPROBES
 	struct kprobe kp = {
 		.symbol_name = "kallsyms_lookup_name",
 	};
@@ -43,10 +46,12 @@ static int find_kallsyms_lookup_name(void)
 
 	__cfs_kallsyms_lookup_name = (void *)kp.addr;
 	if (!__cfs_kallsyms_lookup_name)
-		return -EINVAL;
+		pr_warn("kprobe failed to find kallsyms_lookup_name()");
 
 	unregister_kprobe(&kp);
-
+#else
+	pr_info("Proceeding without CONFIG_PROBES. Some features will be disabled\n");
+#endif
 	return 0;
 }
 #endif
@@ -55,6 +60,8 @@ static struct workqueue_attrs *(*__alloc_workqueue_attrs)(void);
 
 struct workqueue_attrs *compat_alloc_workqueue_attrs(void)
 {
+	if (!__alloc_workqueue_attrs)
+		return NULL;
 	return __alloc_workqueue_attrs();
 }
 EXPORT_SYMBOL_GPL(compat_alloc_workqueue_attrs);
@@ -65,28 +72,39 @@ static int (*__apply_workqueue_attrs)(struct workqueue_struct *wq,
 int compat_apply_workqueue_attrs(struct workqueue_struct *wq,
 				  const struct workqueue_attrs *attrs)
 {
+	if (!__apply_workqueue_attrs)
+		return -ENOENT;
 	return __apply_workqueue_attrs(wq, attrs);
 }
 EXPORT_SYMBOL_GPL(compat_apply_workqueue_attrs);
 
+#ifdef alloc_workqueue_attrs
+# define ALLOC_WQ_ATTRS_FUNC	"alloc_workqueue_attrs_noprof"
+#else
+# define ALLOC_WQ_ATTRS_FUNC	"alloc_workqueue_attrs"
+#endif
+
 int lustre_symbols_init(void)
 {
 	int rc;
 
 	rc = find_kallsyms_lookup_name();
 	if (rc < 0)
-		return rc;
+		pr_warn("find_kallsyms_lookup_name rc:%d\n", rc);
 
 	if (!cfs_kallsyms_lookup_name("kallsyms_lookup_name"))
-		return -EINVAL;
+		pr_warn("cfs_kallsyms_lookup_name failed to find %s()\n",
+			"kallsyms_lookup_name");
 
-	__alloc_workqueue_attrs = cfs_kallsyms_lookup_name("alloc_workqueue_attrs");
+	__alloc_workqueue_attrs = cfs_kallsyms_lookup_name(ALLOC_WQ_ATTRS_FUNC);
 	if (!__alloc_workqueue_attrs)
-		return -EINVAL;
+		pr_warn("cfs_kallsyms_lookup_name failed to find %s()\n",
+			ALLOC_WQ_ATTRS_FUNC);
 
 	__apply_workqueue_attrs = cfs_kallsyms_lookup_name("apply_workqueue_attrs");
 	if (!__apply_workqueue_attrs)
-		return -EINVAL;
+		pr_warn("cfs_kallsyms_lookup_name failed to find %s()\n",
+			"apply_workqueue_attrs");
 
 	return 0;
 }

</pre>
</body>
</html>
