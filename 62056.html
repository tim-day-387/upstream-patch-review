From 220c2b65b2aaa64cf457fd5055c3644c2dedd8fd Mon Sep 17 00:00:00 2001
From: Bruno Faccini <bfaccini@nvidia.com>
Date: Mon, 27 Oct 2025 14:42:07 +0100
Subject: [PATCH 1/1] LU-19516 o2iblnd: destroy pool outside atomic section

To avoid "BUG: scheduling while atomic ..." messages/stacks
upon Lustre modules unload, kiblnd_destroy_[fmr_]pool_list()
functions are now called with an spliced list_head and
without [f]ps_lock spin-locked.

Signed-off-by: Bruno Faccini <bfaccini@nvidia.com>
Change-Id: I056e56d3e93133cb7bbd6a57f9a5a0d1cb177b67
---
 lnet/klnds/o2iblnd/o2iblnd.c | 22 ++++++++++++++++++----
 1 file changed, 18 insertions(+), 4 deletions(-)

diff --git a/lnet/klnds/o2iblnd/o2iblnd.c b/lnet/klnds/o2iblnd/o2iblnd.c
index f253ac264d..d2002594d6 100644
--- a/lnet/klnds/o2iblnd/o2iblnd.c
+++ b/lnet/klnds/o2iblnd/o2iblnd.c
@@ -1830,12 +1830,19 @@ kiblnd_fail_fmr_poolset(struct kib_fmr_poolset *fps, struct list_head *zombies)
 static void
 kiblnd_fini_fmr_poolset(struct kib_fmr_poolset *fps)
 {
+	LIST_HEAD(fps_failed_pool_list);
+	LIST_HEAD(fps_pool_list);
+
 	if (fps->fps_net != NULL) { /* initialized? */
 		/* added spinlock to protect poolset */
 		spin_lock(&fps->fps_lock);
-		kiblnd_destroy_fmr_pool_list(&fps->fps_failed_pool_list);
-		kiblnd_destroy_fmr_pool_list(&fps->fps_pool_list);
+		list_splice(&fps->fps_failed_pool_list, &fps_failed_pool_list);
+		list_splice(&fps->fps_pool_list, &fps_pool_list);
+		INIT_LIST_HEAD(&fps->fps_failed_pool_list);
+		INIT_LIST_HEAD(&fps->fps_pool_list);
 		spin_unlock(&fps->fps_lock);
+		kiblnd_destroy_fmr_pool_list(&fps_failed_pool_list);
+		kiblnd_destroy_fmr_pool_list(&fps_pool_list);
 	}
 }
 
@@ -2222,12 +2229,19 @@ kiblnd_fail_poolset(struct kib_poolset *ps, struct list_head *zombies)
 static void
 kiblnd_fini_poolset(struct kib_poolset *ps)
 {
+	LIST_HEAD(ps_failed_pool_list);
+	LIST_HEAD(ps_pool_list);
+
 	if (ps->ps_net != NULL) { /* initialized? */
 		/* added spinlock to protect poolset */
 		spin_lock(&ps->ps_lock);
-		kiblnd_destroy_pool_list(&ps->ps_failed_pool_list);
-		kiblnd_destroy_pool_list(&ps->ps_pool_list);
+		list_splice(&ps->ps_failed_pool_list, &ps_failed_pool_list);
+		list_splice(&ps->ps_pool_list, &ps_pool_list);
+		INIT_LIST_HEAD(&ps->ps_failed_pool_list);
+		INIT_LIST_HEAD(&ps->ps_pool_list);
 		spin_unlock(&ps->ps_lock);
+		kiblnd_destroy_pool_list(&ps_failed_pool_list);
+		kiblnd_destroy_pool_list(&ps_pool_list);
 	}
 }
 
