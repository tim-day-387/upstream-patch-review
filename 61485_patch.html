<html lang="en">
<body>
<pre>
LU-19400 hsm: full support of HSM cancel

This patch rework the HSM cancel to fix the following issues:
- HSM cancel request are unable to cancel non-started action
- HSM cancel requests are not being prioritized during processing
- Cancels can be sent to the wrong copytool if sent in batch
- If the copytool does not support cancel, the action will succeed

This patch removes HSM cancel record in the llog catalog. This is
replaced by the record state ARS_CANCELING. This simplifies the cancel
process (only one record state to maintain).

Cancels are added in a queue (in cdt_cancel_list) from ptlrpc threads
and proccess in the coordinator thread.

ptlrpc threads try to lookup the request to cancel by FID:
- First in active request hashtable
- Then direcly in the llog catalog.

If the request to cancel is found, the on-disk record is updated to
ARS_CANCELING.

If the request is not started (active), the cancel request is added in
the active request hashtable to avoid the coordinator to send the
request (to copytool) or to register several cancels for the same
record.

The coordinator send the cancel request to the copytool (one-by-one),
if the action is started. Otherwise, it direcly updates the llog
record to ARS_CANCELED.

This patch adds the parameter: mdt.*.hsm.cancel_request_timeout

If the copytool is unresponsive or does not support cancel requests,
the coordinator will set the record to ARS_CANCELED and remove the
active request from the hashtable after the timeout
Then coordinator will ignore hsm_progress from the copytool with the
request cookie canceled.

Add regression test sanity-hsm 205.
This patches update the HSM cancel tests to check the implemented
behaviors.

Test-Parameters: testlist=sanity-hsm env=ONLY=205,ONLY_REPEAT=20
Test-Parameters: testlist=sanity-hsm env=ONLY=206,ONLY_REPEAT=5
Test-Parameters: testlist=sanity-hsm env=ONLY=225,ONLY_REPEAT=20
Test-Parameters: testlist=sanity-hsm env=ONLY="201-205"
Test-Parameters: testlist=sanity-hsm env=ONLY="221-224"
Signed-off-by: Etienne AUJAMES <eaujames@ddn.com>
Change-Id: I5bea1be79ebc7645bb7501952cba2aee489e6daf

</pre>
</body>
</html>
