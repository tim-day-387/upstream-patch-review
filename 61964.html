<html lang="en">
<body>
<pre>
From d0e187c2c376e85b11391d07dd163f2c9007dfb2 Mon Sep 17 00:00:00 2001
From: Patrick Farrell <pfarrell@whamcloud.com>
Date: Thu, 2 Oct 2025 16:01:45 -0400
Subject: [PATCH 1/1] LU-12187 lod: trivial EC cstripe/dstripe support

Add basic support for storing and retrieving EC stripe
counts (dstripe_count and cstripe_count) without using
them for actual EC functionality yet.

Test-Parameters: forjanitoronly
Signed-off-by: Patrick Farrell <pfarrell@whamcloud.com>
Change-Id: I3af69b8072f68e6d2418e136bbce30da072e45a0
---
 lustre/include/lustre/lustreapi.h  |  14 +-
 lustre/lod/lod_internal.h          |   3 +
 lustre/lod/lod_lov.c               |  15 +++
 lustre/lod/lod_object.c            |  18 +++
 lustre/lod/lod_qos.c               |  22 +++
 lustre/lov/lov_ea.c                |   4 +
 lustre/lov/lov_pack.c              |   4 +
 lustre/ptlrpc/pack_generic.c       |   4 +-
 lustre/tests/llapi_layout_test.c   | 207 ++++++++++++++++++++++++++++-
 lustre/utils/liblustreapi.c        |  16 +++
 lustre/utils/liblustreapi_layout.c |  74 +++++++++++
 11 files changed, 377 insertions(+), 4 deletions(-)

diff --git a/lustre/include/lustre/lustreapi.h b/lustre/include/lustre/lustreapi.h
index 9a0f940b5b..e4d1460984 100644
--- a/lustre/include/lustre/lustreapi.h
+++ b/lustre/include/lustre/lustreapi.h
@@ -206,6 +206,7 @@ enum llapi_layout_verbose  {
 	VERBOSE_COMPRESS_TYPE	= 0x200000,
 	VERBOSE_COMPRESS_LEVEL	= 0x400000,
 	VERBOSE_COMPRESS_CHUNK	= 0x800000,
+	VERBOSE_EC_COUNT	= 0x1000000,
 	VERBOSE_DEFAULT		= VERBOSE_STRIPE_COUNT | VERBOSE_STRIPE_SIZE |
 				  VERBOSE_STRIPE_OFFSET | VERBOSE_POOL |
 				  VERBOSE_OBJID | VERBOSE_GENERATION |
@@ -214,7 +215,8 @@ enum llapi_layout_verbose  {
 				  VERBOSE_COMP_START | VERBOSE_COMP_END |
 				  VERBOSE_COMP_ID | VERBOSE_MIRROR_COUNT |
 				  VERBOSE_MIRROR_ID | VERBOSE_EXT_SIZE |
-				  VERBOSE_INHERIT | VERBOSE_INHERIT_RR
+				  VERBOSE_INHERIT | VERBOSE_INHERIT_RR |
+				  VERBOSE_EC_COUNT
 };
 
 enum {
@@ -1386,6 +1388,16 @@ int llapi_layout_comp_add_extent(struct llapi_layout *layout,
 int llapi_layout_comp_add_ec(struct llapi_layout *layout,
 			     uint64_t start, uint64_t end,
 			     uint8_t dstripe_count, uint8_t cstripe_count);
+/**
+ * Get EC coding stripe count from the current component.
+ */
+int llapi_layout_ec_cstripe_count_get(const struct llapi_layout *layout,
+				      uint8_t *cstripe_count);
+/**
+ * Get EC data stripe count from the current component.
+ */
+int llapi_layout_ec_dstripe_count_get(const struct llapi_layout *layout,
+				      uint8_t *dstripe_count);
 /**
  * Adds a first component of a mirror to the existing composite layout.
  */
diff --git a/lustre/lod/lod_internal.h b/lustre/lod/lod_internal.h
index 7f61764138..9a24c67b29 100644
--- a/lustre/lod/lod_internal.h
+++ b/lustre/lod/lod_internal.h
@@ -173,6 +173,9 @@ struct lod_layout_component {
 			struct lu_tgt_pool	  llc_ostlist;
 			struct dt_object	**llc_stripe;
 			__u32			 *llc_ost_indices;
+			/* EC component */
+			__u8			  llc_dstripe_count;
+			__u8			  llc_cstripe_count;
 		};
 		struct { /* Foreign mirror layout component */
 			__u32			  llc_length;
diff --git a/lustre/lod/lod_lov.c b/lustre/lod/lod_lov.c
index 385596a77c..ab4fb7183d 100644
--- a/lustre/lod/lod_lov.c
+++ b/lustre/lod/lod_lov.c
@@ -960,6 +960,12 @@ int lod_generate_lovea(const struct lu_env *env, struct lod_object *lo,
 		if (lod_comp->llc_flags & LCME_FL_NOSYNC)
 			lcme->lcme_timestamp =
 				cpu_to_le64(lod_comp->llc_timestamp);
+		if (lod_comp->llc_flags & LCME_FL_PARITY) {
+			CDEBUG(D_LAYOUT, "Setting EC parameters: dstripe=%u, cstripe=%u\n",
+			       lod_comp->llc_dstripe_count, lod_comp->llc_cstripe_count);
+			lcme->lcme_dstripe_count = lod_comp->llc_dstripe_count;
+			lcme->lcme_cstripe_count = lod_comp->llc_cstripe_count;
+		}
 		if (lod_comp->llc_flags & LCME_FL_EXTENSION && !is_dir)
 			lcm->lcm_magic = cpu_to_le32(LOV_MAGIC_SEL);
 
@@ -1362,6 +1368,15 @@ int lod_parse_striping(const struct lu_env *env, struct lod_object *lo,
 			lod_comp->llc_flags =
 				le32_to_cpu(comp_v1->lcm_entries[i].lcme_flags);
 
+			if (lod_comp->llc_flags & LCME_FL_PARITY) {
+				CDEBUG(D_LAYOUT, "Saving EC parameters: dstripe=%u, cstripe=%u\n",
+				       comp_v1->lcm_entries[i].lcme_dstripe_count,
+				       comp_v1->lcm_entries[i].lcme_cstripe_count);
+				lod_comp->llc_dstripe_count =
+					comp_v1->lcm_entries[i].lcme_dstripe_count;
+				lod_comp->llc_cstripe_count =
+					comp_v1->lcm_entries[i].lcme_cstripe_count;
+			}
 			if (lod_comp->llc_flags & LCME_FL_NOSYNC)
 				lod_comp->llc_timestamp = le64_to_cpu(
 					comp_v1->lcm_entries[i].lcme_timestamp);
diff --git a/lustre/lod/lod_object.c b/lustre/lod/lod_object.c
index 2272e2421d..6ac14acaaf 100644
--- a/lustre/lod/lod_object.c
+++ b/lustre/lod/lod_object.c
@@ -2839,6 +2839,15 @@ static int lod_declare_layout_add(const struct lu_env *env,
 		lod_comp->llc_extent.e_end = ext->e_end;
 		lod_comp->llc_stripe_offset = v1->lmm_stripe_offset;
 		lod_comp->llc_flags = comp_v1->lcm_entries[i].lcme_flags;
+		if (lod_comp->llc_flags & LCME_FL_PARITY) {
+			CDEBUG(D_LAYOUT, "Setting EC parameters: dstripe=%u, cstripe=%u\n",
+			       comp_v1->lcm_entries[i].lcme_dstripe_count,
+			       comp_v1->lcm_entries[i].lcme_cstripe_count);
+			lod_comp->llc_dstripe_count =
+				comp_v1->lcm_entries[i].lcme_dstripe_count;
+			lod_comp->llc_cstripe_count =
+				comp_v1->lcm_entries[i].lcme_cstripe_count;
+		}
 
 		lod_comp->llc_stripe_size = v1->lmm_stripe_size;
 		lod_comp->llc_stripe_count = v1->lmm_stripe_count;
@@ -5436,6 +5445,15 @@ static int lod_get_default_lov_striping(const struct lu_env *env,
 				llc->llc_flags = lcm->lcm_entries[i].lcme_flags &
 					LCME_TEMPLATE_FLAGS;
 			}
+			if (llc->llc_flags & LCME_FL_PARITY) {
+				CDEBUG(D_LAYOUT, "Saving EC parameters: dstripe=%u, cstripe=%u\n",
+				       lcm->lcm_entries[i].lcme_dstripe_count,
+				       lcm->lcm_entries[i].lcme_cstripe_count);
+				llc->llc_dstripe_count =
+					lcm->lcm_entries[i].lcme_dstripe_count;
+				llc->llc_cstripe_count =
+					lcm->lcm_entries[i].lcme_cstripe_count;
+			}
 		}
 
 		CDEBUG(D_LAYOUT, DFID" magic = %#08x, pattern = %#x, stripe_count = %hd, stripe_size = %u, stripe_offset = %hd, append_pool = '%s', append_stripe_count = %d\n",
diff --git a/lustre/lod/lod_qos.c b/lustre/lod/lod_qos.c
index 14ba745509..a58b595f30 100644
--- a/lustre/lod/lod_qos.c
+++ b/lustre/lod/lod_qos.c
@@ -2262,6 +2262,15 @@ int lod_use_defined_striping(const struct lu_env *env,
 			lod_comp->llc_extent.e_end = le64_to_cpu(ext->e_end);
 			lod_comp->llc_flags =
 				le32_to_cpu(comp_v1->lcm_entries[i].lcme_flags);
+			if (lod_comp->llc_flags & LCME_FL_PARITY) {
+				CDEBUG(D_LAYOUT, "Saving EC parameters: dstripe=%u, cstripe=%u\n",
+				       comp_v1->lcm_entries[i].lcme_dstripe_count,
+				       comp_v1->lcm_entries[i].lcme_cstripe_count);
+				lod_comp->llc_dstripe_count =
+					comp_v1->lcm_entries[i].lcme_dstripe_count;
+				lod_comp->llc_cstripe_count =
+					comp_v1->lcm_entries[i].lcme_cstripe_count;
+			}
 			if (lod_comp->llc_flags & LCME_FL_NOSYNC)
 				lod_comp->llc_timestamp = le64_to_cpu(
 					comp_v1->lcm_entries[i].lcme_timestamp);
@@ -2550,6 +2559,19 @@ int lod_qos_parse_config(const struct lu_env *env, struct lod_object *lo,
 					LCME_CL_COMP_FLAGS;
 		}
 
+		ext = &comp_v1->lcm_entries[i].lcme_extent;
+		lod_comp->llc_extent = *ext;
+
+		if (lod_comp->llc_flags & LCME_FL_PARITY) {
+			CDEBUG(D_LAYOUT, "Saving EC parameters: dstripe=%u, cstripe=%u\n",
+			       comp_v1->lcm_entries[i].lcme_dstripe_count,
+			       comp_v1->lcm_entries[i].lcme_cstripe_count);
+			lod_comp->llc_dstripe_count =
+				comp_v1->lcm_entries[i].lcme_dstripe_count;
+			lod_comp->llc_cstripe_count =
+				comp_v1->lcm_entries[i].lcme_cstripe_count;
+		}
+
 		pool_name = NULL;
 		if (def_pool[0] != '\0')
 			pool_name = def_pool;
diff --git a/lustre/lov/lov_ea.c b/lustre/lov/lov_ea.c
index 847d79f39a..e75dd8afd5 100644
--- a/lustre/lov/lov_ea.c
+++ b/lustre/lov/lov_ea.c
@@ -628,6 +628,10 @@ lsm_unpackmd_comp_md_v1(struct lov_obd *lov, void *buf, size_t buf_size)
 		if (lsme->lsme_flags & LCME_FL_NOSYNC)
 			lsme->lsme_timestamp =
 				le64_to_cpu(lcme->lcme_timestamp);
+		if (lsme->lsme_flags & LCME_FL_PARITY) {
+			lsme->lsme_dstripe_count = lcme->lcme_dstripe_count;
+			lsme->lsme_cstripe_count = lcme->lcme_cstripe_count;
+		}
 		lu_extent_le_to_cpu(&lsme->lsme_extent, &lcme->lcme_extent);
 
 		if (i == entry_count - 1) {
diff --git a/lustre/lov/lov_pack.c b/lustre/lov/lov_pack.c
index 9a0ebe1f59..9916058742 100644
--- a/lustre/lov/lov_pack.c
+++ b/lustre/lov/lov_pack.c
@@ -265,6 +265,10 @@ ssize_t lov_lsm_pack(const struct lov_stripe_md *lsm, void *buf,
 		if (lsme->lsme_flags & LCME_FL_NOSYNC)
 			lcme->lcme_timestamp =
 				cpu_to_le64(lsme->lsme_timestamp);
+		if (lsme->lsme_flags & LCME_FL_PARITY) {
+			lcme->lcme_dstripe_count = lsme->lsme_dstripe_count;
+			lcme->lcme_cstripe_count = lsme->lsme_cstripe_count;
+		}
 		lcme->lcme_extent.e_start =
 			cpu_to_le64(lsme->lsme_extent.e_start);
 		lcme->lcme_extent.e_end =
diff --git a/lustre/ptlrpc/pack_generic.c b/lustre/ptlrpc/pack_generic.c
index 4c4736ba01..7621247ff6 100644
--- a/lustre/ptlrpc/pack_generic.c
+++ b/lustre/ptlrpc/pack_generic.c
@@ -2458,9 +2458,9 @@ void lustre_print_user_md(unsigned int lvl, struct lov_user_md *lum,
 			CDEBUG(lvl, "\tlcme_timestamp: %llu\n",
 					ent->lcme_timestamp);
 		if (ent->lcme_flags & LCME_FL_PARITY) {
-			CDEBUG(lvl, "\tlcme_dstripe_count: %#x\n",
+			CDEBUG(lvl, "\tlcme_dstripe_count: %u\n",
 			       ent->lcme_dstripe_count);
-			CDEBUG(lvl, "\tlcme_cstripe_count: %#x\n",
+			CDEBUG(lvl, "\tlcme_cstripe_count: %u\n",
 			       ent->lcme_cstripe_count);
 		}
 		CDEBUG(lvl, "\tlcme_extent.e_start: %llu\n",
diff --git a/lustre/tests/llapi_layout_test.c b/lustre/tests/llapi_layout_test.c
index 9bf5b0225f..e58e23a8cb 100644
--- a/lustre/tests/llapi_layout_test.c
+++ b/lustre/tests/llapi_layout_test.c
@@ -44,7 +44,7 @@ do {									\
 	ASSERTF(cond, fmt, ## __VA_ARGS__);				\
 } while (0)
 
-static void usage(char *prog)
+static void __attribute__((unused)) usage(char *prog)
 {
 	printf("Usage: %s [-d lustre_dir] [-p pool_name] [-o num_osts] "
 	       "[-s $n,$m,... (skip tests)] [-t $n,$m,... (run tests)]\n",
@@ -2175,6 +2175,102 @@ static void test49(void)
 	llapi_layout_free(layout);
 }
 
+/**
+ * Helper function to verify a component's EC parameters.
+ *
+ * \param[in] layout		layout to verify
+ * \param[in] expected_cstripe	expected cstripe count (0 for non-EC)
+ * \param[in] expected_dstripe	expected dstripe count (0 for non-EC)
+ * \param[in] comp_desc		description for error messages
+ */
+static void __attribute__((unused)) __verify_ec_comp(struct llapi_layout *layout,
+			     uint8_t expected_cstripe,
+			     uint8_t expected_dstripe,
+			     const char *comp_desc)
+{
+	uint32_t flags;
+	uint8_t cstripe, dstripe;
+	int rc;
+
+	rc = llapi_layout_comp_flags_get(layout, &flags);
+	ASSERTF(rc == 0, "%s: failed to get flags, errno = %d",
+		comp_desc, errno);
+
+	if (expected_cstripe == 0 && expected_dstripe == 0) {
+		/* Non-EC component - should not have PARITY flag */
+		ASSERTF(!(flags & LCME_FL_PARITY),
+			"%s: unexpected PARITY flag set", comp_desc);
+		return;
+	}
+
+	/* EC component - should have PARITY flag */
+	ASSERTF(flags & LCME_FL_PARITY,
+		"%s: PARITY flag not set", comp_desc);
+
+	rc = llapi_layout_ec_cstripe_count_get(layout, &cstripe);
+	ASSERTF(rc == 0, "%s: failed to get cstripe, errno = %d",
+		comp_desc, errno);
+	ASSERTF(cstripe == expected_cstripe,
+		"%s: cstripe %u != expected %u",
+		comp_desc, cstripe, expected_cstripe);
+
+	rc = llapi_layout_ec_dstripe_count_get(layout, &dstripe);
+	ASSERTF(rc == 0, "%s: failed to get dstripe, errno = %d",
+		comp_desc, errno);
+	ASSERTF(dstripe == expected_dstripe,
+		"%s: dstripe %u != expected %u",
+		comp_desc, dstripe, expected_dstripe);
+}
+
+/**
+ * Helper function to verify a component's extent.
+ *
+ * \param[in] layout		layout to verify
+ * \param[in] expected_start	expected extent start
+ * \param[in] expected_end	expected extent end
+ * \param[in] comp_desc		description for error messages
+ */
+static void __attribute__((unused)) __verify_comp_extent(struct llapi_layout *layout,
+				 uint64_t expected_start,
+				 uint64_t expected_end,
+				 const char *comp_desc)
+{
+	uint64_t start, end;
+	int rc;
+
+	rc = llapi_layout_comp_extent_get(layout, &start, &end);
+	ASSERTF(rc == 0, "%s: failed to get extent, errno = %d",
+		comp_desc, errno);
+	ASSERTF(start == expected_start,
+		"%s: extent start %"PRIu64" != expected %"PRIu64,
+		comp_desc, start, expected_start);
+	ASSERTF(end == expected_end,
+		"%s: extent end %"PRIu64" != expected %"PRIu64,
+		comp_desc, end, expected_end);
+}
+
+/**
+ * Helper function to verify a component's stripe count.
+ *
+ * \param[in] layout		layout to verify
+ * \param[in] expected_count	expected stripe count
+ * \param[in] comp_desc		description for error messages
+ */
+static void __attribute__((unused)) __verify_stripe_count(struct llapi_layout *layout,
+				  uint64_t expected_count,
+				  const char *comp_desc)
+{
+	uint64_t count;
+	int rc;
+
+	rc = llapi_layout_stripe_count_get(layout, &count);
+	ASSERTF(rc == 0, "%s: failed to get stripe count, errno = %d",
+		comp_desc, errno);
+	ASSERTF(count == expected_count,
+		"%s: stripe count %"PRIu64" != expected %"PRIu64,
+		comp_desc, count, expected_count);
+}
+
 #define T50FILE		"f50"
 #define T50_DESC	"create simple EC layout with data and parity components"
 static void test50(void)
@@ -2219,6 +2315,27 @@ static void test50(void)
 	ASSERTF(rc == 0, "errno = %d", errno);
 
 	llapi_layout_free(layout);
+
+	/* Verify the created file has the correct layout */
+	layout = llapi_layout_get_by_path(path, 0);
+	ASSERTF(layout != NULL, "errno = %d", errno);
+
+	/* Move to first component (Mirror 1, data component) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_FIRST);
+	ASSERTF(rc == 0, "errno = %d", errno);
+
+	__verify_comp_extent(layout, 0, LUSTRE_EOF, "M1 data comp");
+	/* Note: stripe count may be capped by number of OSTs */
+	__verify_ec_comp(layout, 0, 0, "M1 data comp");
+
+	/* Move to second component (Mirror 2, EC parity component) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+
+	__verify_comp_extent(layout, 0, LUSTRE_EOF, "M2 EC parity");
+	__verify_ec_comp(layout, 2, 6, "M2 EC parity");
+
+	llapi_layout_free(layout);
 }
 
 #define T51FILE		"f51"
@@ -2285,6 +2402,36 @@ static void test51(void)
 	ASSERTF(rc == 0, "errno = %d", errno);
 
 	llapi_layout_free(layout);
+
+	/* Verify the created file has the correct layout */
+	layout = llapi_layout_get_by_path(path, 0);
+	ASSERTF(layout != NULL, "errno = %d", errno);
+
+	/* M1 COMP1: [0, 1GiB] - data component */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_FIRST);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 0, 1024*1024*1024ULL, "M1 COMP1");
+	__verify_ec_comp(layout, 0, 0, "M1 COMP1");
+
+	/* M1 COMP2: [1GiB, EOF] - data component */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 1024*1024*1024ULL, LUSTRE_EOF, "M1 COMP2");
+	__verify_ec_comp(layout, 0, 0, "M1 COMP2");
+
+	/* M2 EC1: [0, 1GiB] with EC(2,4) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 0, 1024*1024*1024ULL, "M2 EC1");
+	__verify_ec_comp(layout, 2, 4, "M2 EC1");
+
+	/* M2 EC2: [1GiB, EOF] with EC(2,6) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 1024*1024*1024ULL, LUSTRE_EOF, "M2 EC2");
+	__verify_ec_comp(layout, 2, 6, "M2 EC2");
+
+	llapi_layout_free(layout);
 }
 
 #define T52FILE		"f52"
@@ -2383,6 +2530,64 @@ static void test52(void)
 	ASSERTF(rc == 0, "errno = %d", errno);
 
 	llapi_layout_free(layout);
+
+	/* Verify the created file has the correct layout */
+	layout = llapi_layout_get_by_path(path, 0);
+	ASSERTF(layout != NULL, "errno = %d", errno);
+
+	/* M1 COMP1: [0, 256MiB] - data component */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_FIRST);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 0, 256*1024*1024ULL, "M1 COMP1");
+	__verify_ec_comp(layout, 0, 0, "M1 COMP1");
+
+	/* M1 COMP2: [256MiB, 512MiB] - data component */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 256*1024*1024ULL, 512*1024*1024ULL,
+			     "M1 COMP2");
+	__verify_ec_comp(layout, 0, 0, "M1 COMP2");
+
+	/* M1 COMP3: [512MiB, 1GiB] - data component */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 512*1024*1024ULL, 1024*1024*1024ULL,
+			     "M1 COMP3");
+	__verify_ec_comp(layout, 0, 0, "M1 COMP3");
+
+	/* M1 COMP4: [1GiB, EOF] - data component */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 1024*1024*1024ULL, LUSTRE_EOF, "M1 COMP4");
+	__verify_ec_comp(layout, 0, 0, "M1 COMP4");
+
+	/* M2 EC1: [0, 256MiB] with EC(1,2) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 0, 256*1024*1024ULL, "M2 EC1");
+	__verify_ec_comp(layout, 1, 2, "M2 EC1");
+
+	/* M2 EC2: [256MiB, 512MiB] with EC(2,4) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 256*1024*1024ULL, 512*1024*1024ULL,
+			     "M2 EC2");
+	__verify_ec_comp(layout, 2, 4, "M2 EC2");
+
+	/* M2 EC3: [512MiB, 1GiB] with EC(2,6) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 512*1024*1024ULL, 1024*1024*1024ULL,
+			     "M2 EC3");
+	__verify_ec_comp(layout, 2, 6, "M2 EC3");
+
+	/* M2 EC4: [1GiB, EOF] with EC(3,8) */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT);
+	ASSERTF(rc == 0, "errno = %d", errno);
+	__verify_comp_extent(layout, 1024*1024*1024ULL, LUSTRE_EOF, "M2 EC4");
+	__verify_ec_comp(layout, 3, 8, "M2 EC4");
+
+	llapi_layout_free(layout);
 }
 
 #define T53FILE		"f53"
diff --git a/lustre/utils/liblustreapi.c b/lustre/utils/liblustreapi.c
index 6480069ed7..d6d0bf0e61 100644
--- a/lustre/utils/liblustreapi.c
+++ b/lustre/utils/liblustreapi.c
@@ -3341,6 +3341,22 @@ static void lov_dump_comp_v1_entry(struct find_param *param,
 		separator = "\n";
 	}
 
+	/* Display EC-specific information for parity components */
+	if (verbose & VERBOSE_EC_COUNT &&
+	    (entry->lcme_flags & LCME_FL_PARITY)) {
+		llapi_printf(LLAPI_MSG_NORMAL, "%s", separator);
+		if (verbose & ~VERBOSE_EC_COUNT)
+			llapi_printf(LLAPI_MSG_NORMAL,
+				     "%4slcme_dstripe_count:  ", " ");
+		llapi_printf(LLAPI_MSG_NORMAL, "%u%s",
+				entry->lcme_dstripe_count, separator);
+		if (verbose & ~VERBOSE_EC_COUNT)
+			llapi_printf(LLAPI_MSG_NORMAL,
+				     "%4slcme_cstripe_count:  ", " ");
+		llapi_printf(LLAPI_MSG_NORMAL, "%u", entry->lcme_cstripe_count);
+		separator = "\n";
+	}
+
 	if (verbose & VERBOSE_COMP_START) {
 		llapi_printf(LLAPI_MSG_NORMAL, "%s", separator);
 		if (verbose & ~VERBOSE_COMP_START)
diff --git a/lustre/utils/liblustreapi_layout.c b/lustre/utils/liblustreapi_layout.c
index 7928bbdaa1..49fcf36441 100644
--- a/lustre/utils/liblustreapi_layout.c
+++ b/lustre/utils/liblustreapi_layout.c
@@ -649,6 +649,12 @@ struct llapi_layout *llapi_layout_get_by_xattr(void *lov_xattr,
 			comp->llc_flags = ent->lcme_flags;
 			if (comp->llc_flags & LCME_FL_NOSYNC)
 				comp->llc_timestamp = ent->lcme_timestamp;
+			if (comp->llc_flags & LCME_FL_PARITY) {
+				comp->llc_dstripe_count =
+				ent->lcme_dstripe_count;
+				comp->llc_cstripe_count =
+				ent->lcme_cstripe_count;
+			}
 		} else {
 			comp->llc_extent.e_start = 0;
 			comp->llc_extent.e_end = LUSTRE_EOF;
@@ -962,6 +968,10 @@ llapi_layout_to_lum(const struct llapi_layout *layout)
 			ent->lcme_flags = comp->llc_flags;
 			if (ent->lcme_flags & LCME_FL_NOSYNC)
 				ent->lcme_timestamp = comp->llc_timestamp;
+			if (ent->lcme_flags & LCME_FL_PARITY) {
+				ent->lcme_dstripe_count = comp->llc_dstripe_count;
+				ent->lcme_cstripe_count = comp->llc_cstripe_count;
+			}
 			ent->lcme_extent.e_start = comp->llc_extent.e_start;
 			ent->lcme_extent.e_end = comp->llc_extent.e_end;
 			ent->lcme_size = blob_size;
@@ -2446,6 +2456,70 @@ int llapi_layout_comp_add_ec(struct llapi_layout *layout,
 	return 0;
 }
 
+/**
+ * Get EC coding stripe count from the current component.
+ *
+ * \param[in] layout		existing layout
+ * \param[out] cstripe_count	EC coding stripe count
+ *
+ * \retval	0 on success
+ * \retval	<0 if error occurs
+ */
+int llapi_layout_ec_cstripe_count_get(const struct llapi_layout *layout,
+				      uint8_t *cstripe_count)
+{
+	struct llapi_layout_comp *comp;
+
+	comp = __llapi_layout_cur_comp(layout);
+	if (comp == NULL)
+		return -1;
+
+	if (cstripe_count == NULL) {
+		errno = EINVAL;
+		return -1;
+	}
+
+	if (!(comp->llc_flags & LCME_FL_PARITY)) {
+		errno = EINVAL;
+		return -1;
+	}
+
+	*cstripe_count = comp->llc_cstripe_count;
+	return 0;
+}
+
+/**
+ * Get EC data stripe count from the current component.
+ *
+ * \param[in] layout		existing layout
+ * \param[out] dstripe_count	EC data stripe count
+ *
+ * \retval	0 on success
+ * \retval	<0 if error occurs
+ */
+int llapi_layout_ec_dstripe_count_get(const struct llapi_layout *layout,
+				      uint8_t *dstripe_count)
+{
+	struct llapi_layout_comp *comp;
+
+	comp = __llapi_layout_cur_comp(layout);
+	if (comp == NULL)
+		return -1;
+
+	if (dstripe_count == NULL) {
+		errno = EINVAL;
+		return -1;
+	}
+
+	if (!(comp->llc_flags & LCME_FL_PARITY)) {
+		errno = EINVAL;
+		return -1;
+	}
+
+	*dstripe_count = comp->llc_dstripe_count;
+	return 0;
+}
+
 /**
  * Adds a first component of a mirror to \a layout.
  * The \a layout will change it's current component pointer to

</pre>
</body>
</html>
