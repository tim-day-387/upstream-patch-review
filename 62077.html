<html lang="en">
<body>
<pre>
From ed80eda2e2e97957c52eba860d07123e9af926ab Mon Sep 17 00:00:00 2001
From: Patrick Farrell <pfarrell@whamcloud.com>
Date: Tue, 28 Oct 2025 12:18:06 -0400
Subject: [PATCH 1/1] LU-19533 tests: add EC mirror read/write test

Add test_3 to sanity-ec.sh to verify lfs mirror read/write
commands work correctly with EC parity mirrors. The test is
adapted from sanity-flr.sh test_0j and verifies that:

- Mirror read can read from EC parity mirror
- Mirror write can write to EC parity mirror
- Mirror write does not cause stale components
- After marking data mirror stale and resyncing, data from
  parity mirror propagates to data mirror

Test-Parameters: forjanitoronly
Signed-off-by: Patrick Farrell <pfarrell@whamcloud.com>
Change-Id: I16dbf896bb036e69a059d3d264c9fd6e97bfc88e
---
 lustre/tests/sanity-ec.sh | 53 +++++++++++++++++++++++++++++++++++++++
 1 file changed, 53 insertions(+)

diff --git a/lustre/tests/sanity-ec.sh b/lustre/tests/sanity-ec.sh
index f982aef746..a86638a3eb 100755
--- a/lustre/tests/sanity-ec.sh
+++ b/lustre/tests/sanity-ec.sh
@@ -237,6 +237,59 @@ test_2() {
 }
 run_test 2 "EC FLR state transitions with writes to different components"
 
+test_3() {
+	# Adapted from sanity-flr.sh test_0j
+	# Test lfs mirror read/write commands on EC parity mirror
+	local tf=$DIR/$tfile
+	local ec_create=$LUSTRE/../ec_create_simple
+
+	[[ -x $ec_create ]] || skip "ec_create_simple not found or not executable"
+
+	stack_trap "rm -f $tf $TMP/$tfile $TMP/$tfile.mirror1"
+
+	# Create EC file with data mirror + parity mirror
+	$ec_create $tf || error "ec_create_simple failed"
+
+	# Write initial data and resync
+	cp /etc/hosts $tf || error "write to $tf failed"
+	$LFS mirror resync $tf || error "resync $tf failed"
+	verify_flr_state $tf "ro"
+	cmp /etc/hosts $tf || error "cmp with /etc/hosts failed"
+
+	# Test mirror read from parity mirror (N2)
+	$LFS mirror read -N2 -o $TMP/$tfile $tf ||
+		error "mirror read from parity mirror failed"
+	cmp $TMP/$tfile $tf || error "cmp with $TMP/$tfile failed"
+
+	# Test mirror write to parity mirror (N2)
+	$LFS mirror write -N2 -i /etc/passwd $tf ||
+		error "mirror write to parity mirror failed"
+
+	# Verify file is still in RDONLY state
+	# Mirror write should NOT cause state transition or stale components
+	verify_flr_state $tf "ro"
+
+	# Verify no components are stale after mirror write
+	$LFS getstripe $tf | grep lcme_flags | grep stale &&
+		error "mirror write caused stale components"
+
+	# Get component IDs to manually mark data mirror as stale
+	local ids=($($LFS getstripe $tf | awk '/lcme_id/{print $2}' |
+			tr '\n' ' '))
+
+	# Mark first component of data mirror (mirror 1) as stale
+	$LFS setstripe --comp-set -I ${ids[0]} --comp-flags=stale $tf ||
+		error "set component ${ids[0]} stale failed"
+
+	# Resync should propagate parity mirror data to data mirror
+	$LFS mirror resync $tf || error "resync $tf failed"
+	verify_flr_state $tf "ro"
+
+	# After resync, normal read should show /etc/passwd
+	cmp /etc/passwd $tf || error "cmp with /etc/passwd failed after resync"
+}
+run_test 3 "EC mirror read/write commands (adapted from sanity-flr test_0j)"
+
 complete_test $SECONDS
 check_and_cleanup_lustre
 exit_status

</pre>
</body>
</html>
