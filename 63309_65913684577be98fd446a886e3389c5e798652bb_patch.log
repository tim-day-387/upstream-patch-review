LU-19771 lfsck: lfsck_namespace_assistant_handler_p1 refactor

lfsck_namespace_assistant_handler_p1() is too long and complex,
so split it into smaller chunks.
This was done using auggie agent with whatever the default llm
it uses:

Original Function
  • Size: ~527 lines (lines 5575-6102)
  • Complexity: Highly convoluted with deeply nested logic, multiple
    goto labels, and complex state management
  • Readability: Very difficult to understand due to length and
    complexity

Refactored Structure

The function has been split into 7 focused helper functions plus the
refactored main function:

1. lfsck_namespace_check_early_validation() (~60 lines)
  • Handles early validation checks (dead objects, zero/invalid FIDs,
    special cases)
  • Returns special codes for striped directory rescan and striped
    master handling

2. lfsck_namespace_resolve_mdt_device() (~50 lines)
  • Resolves the MDT device for a given FID
  • Handles both local and remote MDT cases

3. lfsck_namespace_handle_dangling_obj() (~35 lines)
  • Handles non-existent (dangling) objects
  • Checks validity and repairs dangling references

4. lfsck_namespace_process_linkea() (~90 lines)
  • Reads and processes linkEA data
  • Determines if linkEA is valid or needs repair
  • Returns clear status codes for different scenarios

5. lfsck_namespace_repair_linkea() (~70 lines)
  • Repairs missing or corrupted linkEA
  • Handles removal of old linkEA and creation of new linkEA
  • Updates statistics

6. lfsck_namespace_handle_bad_hash() (~40 lines)
  • Handles bad name hash repair
  • Validates name entries against striped directories

7. lfsck_namespace_report_result() (~85 lines)
  • Reports repair results and updates statistics
  • Handles error reporting and success logging
  • Updates namespace flags and counters

8. Refactored Main Function (~277 lines)
  • Now much more readable with clear sections
  • Each section calls a focused helper function
  • Comments clearly indicate what each section does
  • Reduced complexity and improved flow

Key Improvements

  1. Readability: The main function now reads like a high-level workflow
     with clear steps
  2. Maintainability: Each helper function has a single, well-defined
     responsibility
  3. Testability: Helper functions can be tested independently
  4. Documentation: Each helper function has comprehensive documentation
  5. Code Reuse: Helper functions can potentially be reused elsewhere
  6. Reduced Complexity: Deeply nested logic has been extracted into
     focused functions
  7. Better Error Handling: Error paths are clearer and more consistent

Change-Id: Ib8f12cdb3c583bde3612cd9571976212f47387ae
Signed-off-by: Oleg Drokin <green@whamcloud.com>
