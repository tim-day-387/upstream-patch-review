<html lang="en">
<body>
<pre>
From f9476e595faf58cc0e6e8ded660f069788205779 Mon Sep 17 00:00:00 2001
From: Patrick Farrell <pfarrell@whamcloud.com>
Date: Wed, 29 Oct 2025 12:54:55 -0400
Subject: [PATCH 1/1] LU-0000 lfs: add mirror mode support for EC layouts

Add support for creating EC (Erasure Coding) layouts with
mirror mode (-N flag) in lfs setstripe. Previously, --ec
only worked in non-mirror mode.

Implementation:
- Modified add_ec_parity_components() to add EC parity
  components directly to the data mirror's layout using
  llapi_layout_comp_add_ec(), which automatically creates
  a new mirror within the same layout object
- Added m_has_ec flag to mirror_args structure to indicate
  that a layout already contains EC parity components
  (i.e., contains 2 mirrors: data + parity)
- Updated mirror count calculation in mirror_create() to
  multiply by 2 when m_has_ec is true, since each merge
  adds 2 mirrors (data + parity) instead of 1
- Skip standalone validation of layouts with EC parity,
  as they will be validated after merging in mirror_create()

User-facing behavior:
- lfs setstripe -N -E 128M -E -1 --ec 8+2 creates 2 mirrors
  (1 data + 1 parity) with 4 components total
- lfs setstripe -N2 -E 128M -E -1 --ec 8+2 creates 4 mirrors
  (2 data + 2 parity) with 8 components total
- Multiple data mirrors can each have their own EC config

Test-Parameters: trivial
Signed-off-by: Patrick Farrell <pfarrell@whamcloud.com>
Change-Id: I66ba351c3c68e978d4b9257091195366f44248df
---
 lustre/tests/sanity-ec.sh          | 186 +++++++++++++++++
 lustre/utils/lfs.c                 | 319 +++++++++++++++++++++++++----
 lustre/utils/liblustreapi_layout.c |   2 +
 3 files changed, 472 insertions(+), 35 deletions(-)

diff --git a/lustre/tests/sanity-ec.sh b/lustre/tests/sanity-ec.sh
index c23685e900..ca3ec14e15 100644
--- a/lustre/tests/sanity-ec.sh
+++ b/lustre/tests/sanity-ec.sh
@@ -342,6 +342,192 @@ test_1f() {
 }
 run_test 1f "setstripe with different parity counts"
 
+test_2a() {
+	local tf=$DIR/$tfile
+	local ids
+
+	# Single data mirror with EC using -N
+	$LFS setstripe -N -E 128M -E -1 --ec 8+2 $tf ||
+		error "setstripe failed"
+
+	verify_mirror_count $tf 2
+	verify_comp_count $tf 4
+
+	# Get component IDs
+	ids=($($LFS getstripe $tf | awk '/lcme_id/{print $2}' | tr '\n' ' '))
+
+	# Verify data mirror (mirror 1)
+	verify_comp_extent $tf ${ids[0]} 0 134217728
+	verify_comp_extent $tf ${ids[1]} 134217728 EOF
+
+	# Verify parity mirror (mirror 2)
+	verify_comp_parity $tf ${ids[2]}
+	verify_ec_stripe_count $tf ${ids[2]} 8 2
+	verify_comp_extent $tf ${ids[2]} 0 134217728
+
+	verify_comp_parity $tf ${ids[3]}
+	verify_ec_stripe_count $tf ${ids[3]} 8 2
+	verify_comp_extent $tf ${ids[3]} 134217728 EOF
+
+	rm -f $tf
+}
+run_test 2a "setstripe with -N and EC"
+
+test_2b() {
+	local tf=$DIR/$tfile
+	local ids
+
+	# Two data mirrors, one with EC
+	$LFS setstripe -N -E 128M -E -1 --ec 8+2 \
+			-N -E 256M -E -1 \
+			$tf || error "setstripe failed"
+
+	verify_mirror_count $tf 3
+	verify_comp_count $tf 6
+
+	# Get component IDs
+	ids=($($LFS getstripe $tf | awk '/lcme_id/{print $2}' | tr '\n' ' '))
+
+	# Verify mirror 1 (data with EC)
+	verify_comp_extent $tf ${ids[0]} 0 134217728
+	verify_comp_extent $tf ${ids[1]} 134217728 EOF
+
+	# Verify mirror 2 (parity for mirror 1)
+	verify_comp_parity $tf ${ids[2]}
+	verify_ec_stripe_count $tf ${ids[2]} 8 2
+	verify_comp_extent $tf ${ids[2]} 0 134217728
+
+	verify_comp_parity $tf ${ids[3]}
+	verify_ec_stripe_count $tf ${ids[3]} 8 2
+	verify_comp_extent $tf ${ids[3]} 134217728 EOF
+
+	# Verify mirror 3 (data without EC)
+	verify_comp_extent $tf ${ids[4]} 0 268435456
+	verify_comp_extent $tf ${ids[5]} 268435456 EOF
+
+	rm -f $tf
+}
+run_test 2b "setstripe with -N: two data mirrors, one with EC"
+
+test_2c() {
+	local tf=$DIR/$tfile
+	local ids
+
+	# Two data mirrors, both with EC
+	$LFS setstripe -N -E 128M --ec 4+2 -E -1 --ec 8+2 \
+			-N -E 256M --ec 6+1 -E -1 \
+			$tf || error "setstripe failed"
+
+	verify_mirror_count $tf 4
+	verify_comp_count $tf 8
+
+	# Get component IDs
+	ids=($($LFS getstripe $tf | awk '/lcme_id/{print $2}' | tr '\n' ' '))
+
+	# Verify mirror 1 (data)
+	verify_comp_extent $tf ${ids[0]} 0 134217728
+	verify_comp_extent $tf ${ids[1]} 134217728 EOF
+
+	# Verify mirror 2 (parity for mirror 1)
+	verify_comp_parity $tf ${ids[2]}
+	verify_ec_stripe_count $tf ${ids[2]} 4 2
+	verify_comp_extent $tf ${ids[2]} 0 134217728
+
+	verify_comp_parity $tf ${ids[3]}
+	verify_ec_stripe_count $tf ${ids[3]} 8 2
+	verify_comp_extent $tf ${ids[3]} 134217728 EOF
+
+	# Verify mirror 3 (data)
+	verify_comp_extent $tf ${ids[4]} 0 268435456
+	verify_comp_extent $tf ${ids[5]} 268435456 EOF
+
+	# Verify mirror 4 (parity for mirror 3)
+	verify_comp_parity $tf ${ids[6]}
+	verify_ec_stripe_count $tf ${ids[6]} 6 1
+	verify_comp_extent $tf ${ids[6]} 0 268435456
+
+	verify_comp_parity $tf ${ids[7]}
+	verify_ec_stripe_count $tf ${ids[7]} 6 1
+	verify_comp_extent $tf ${ids[7]} 268435456 EOF
+
+	rm -f $tf
+}
+run_test 2c "setstripe with -N: two data mirrors, both with EC"
+
+test_2d() {
+	local tf=$DIR/$tfile
+	local ids
+
+	# Multiple identical EC mirrors using -N count
+	$LFS setstripe -N2 -E 128M -E -1 --ec 8+2 $tf ||
+		error "setstripe failed"
+
+	verify_mirror_count $tf 4
+	verify_comp_count $tf 8
+
+	# Get component IDs
+	ids=($($LFS getstripe $tf | awk '/lcme_id/{print $2}' | tr '\n' ' '))
+
+	# Verify mirror 1 (data)
+	verify_comp_extent $tf ${ids[0]} 0 134217728
+	verify_comp_extent $tf ${ids[1]} 134217728 EOF
+
+	# Verify mirror 2 (parity for mirror 1)
+	verify_comp_parity $tf ${ids[2]}
+	verify_ec_stripe_count $tf ${ids[2]} 8 2
+	verify_comp_extent $tf ${ids[2]} 0 134217728
+
+	verify_comp_parity $tf ${ids[3]}
+	verify_ec_stripe_count $tf ${ids[3]} 8 2
+	verify_comp_extent $tf ${ids[3]} 134217728 EOF
+
+	# Verify mirror 3 (data, identical to mirror 1)
+	verify_comp_extent $tf ${ids[4]} 0 134217728
+	verify_comp_extent $tf ${ids[5]} 134217728 EOF
+
+	# Verify mirror 4 (parity for mirror 3, identical to mirror 2)
+	verify_comp_parity $tf ${ids[6]}
+	verify_ec_stripe_count $tf ${ids[6]} 8 2
+	verify_comp_extent $tf ${ids[6]} 0 134217728
+
+	verify_comp_parity $tf ${ids[7]}
+	verify_ec_stripe_count $tf ${ids[7]} 8 2
+	verify_comp_extent $tf ${ids[7]} 134217728 EOF
+
+	rm -f $tf
+}
+run_test 2d "setstripe with -N2: multiple identical EC mirrors"
+
+test_2e() {
+	local tf=$DIR/$tfile
+	local ids
+
+	# Mixed: regular mirror + EC mirror
+	$LFS setstripe -N -E -1 -c 4 \
+			-N -E -1 -c 8 --ec 8+2 \
+			$tf || error "setstripe failed"
+
+	verify_mirror_count $tf 3
+	verify_comp_count $tf 3
+
+	# Get component IDs
+	ids=($($LFS getstripe $tf | awk '/lcme_id/{print $2}' | tr '\n' ' '))
+
+	# Verify mirror 1 (data, no EC)
+	verify_comp_extent $tf ${ids[0]} 0 EOF
+
+	# Verify mirror 2 (data with EC)
+	verify_comp_extent $tf ${ids[1]} 0 EOF
+
+	# Verify mirror 3 (parity for mirror 2)
+	verify_comp_parity $tf ${ids[2]}
+	verify_ec_stripe_count $tf ${ids[2]} 8 2
+	verify_comp_extent $tf ${ids[2]} 0 EOF
+
+	rm -f $tf
+}
+run_test 2e "setstripe with -N: mixed regular and EC mirrors"
+
 complete_test $SECONDS
 check_and_cleanup_lustre
 exit_status
diff --git a/lustre/utils/lfs.c b/lustre/utils/lfs.c
index e5b1f0bf9e..e26a7af4a2 100644
--- a/lustre/utils/lfs.c
+++ b/lustre/utils/lfs.c
@@ -1647,6 +1647,8 @@ static int mirror_str2state(char *string, __u16 *state, __u16 *neg_state)
  * @m_layout: Mirror layout.
  * @m_file:   A victim file. Its layout will be split and used as a mirror.
  * @m_next:   Point to the next node of the list.
+ * @m_inherit: Whether to inherit unspecified attributes from previous mirror.
+ * @m_has_ec: True if this layout already contains EC parity components.
  *
  * Command-line arguments for mirror(s) will be parsed and stored in
  * a linked list that consists of this structure.
@@ -1658,6 +1660,7 @@ struct mirror_args {
 	const char		*m_file;
 	struct mirror_args	*m_next;
 	bool			m_inherit;
+	bool			m_has_ec;
 };
 
 /**
@@ -1729,11 +1732,17 @@ static int mirror_create_sanity_check(const char *fname,
 				return -EINVAL;
 			}
 		}
-		rc = llapi_layout_v2_sanity(list->m_layout, false, true,
-					    fsname);
-		if (rc) {
-			llapi_layout_sanity_perror(rc);
-			return rc;
+
+		/* Skip validation for layouts with EC parity - they will
+		 * be validated after merging in mirror_create().
+		 */
+		if (!list->m_has_ec) {
+			rc = llapi_layout_v2_sanity(list->m_layout, false, true,
+						    fsname);
+			if (rc) {
+				llapi_layout_sanity_perror(rc);
+				return rc;
+			}
 		}
 
 		list = list->m_next;
@@ -1792,6 +1801,7 @@ static int mirror_create(char *fname, struct mirror_args *mirror_list)
 
 	cur_mirror = mirror_list;
 	while (cur_mirror) {
+
 		rc = llapi_layout_comp_iterate(cur_mirror->m_layout,
 					       mirror_set_flags,
 					       &cur_mirror->m_flags);
@@ -1802,6 +1812,12 @@ static int mirror_create(char *fname, struct mirror_args *mirror_list)
 			goto error;
 		}
 
+		/* If this layout already contains EC parity components,
+		 * the layout contains multiple mirrors (data + parity).
+		 * We need to merge it m_count times, and each merge adds
+		 * 2 mirrors (data + parity), so the total mirror count
+		 * is m_count * 2.
+		 */
 		for (i = 0; i < cur_mirror->m_count; i++) {
 			rc = llapi_layout_merge(&layout, cur_mirror->m_layout);
 			if (rc) {
@@ -1812,7 +1828,16 @@ static int mirror_create(char *fname, struct mirror_args *mirror_list)
 				goto error;
 			}
 		}
-		mirror_count += cur_mirror->m_count;
+
+		if (cur_mirror->m_has_ec) {
+			/* Layout contains 2 mirrors (data + parity), so
+			 * each merge adds 2 mirrors.
+			 */
+			mirror_count += cur_mirror->m_count * 2;
+		} else {
+			mirror_count += cur_mirror->m_count;
+		}
+
 		cur_mirror = cur_mirror->m_next;
 	}
 
@@ -1829,6 +1854,14 @@ static int mirror_create(char *fname, struct mirror_args *mirror_list)
 		goto error;
 	}
 
+	/* Validate the merged layout */
+	rc = llapi_layout_sanity(layout, false, true);
+	if (rc) {
+		llapi_layout_sanity_perror(rc);
+		rc = -EINVAL;
+		goto error;
+	}
+
 	rc = lfs_component_create(fname, O_CREAT | O_WRONLY, 0666,
 				  layout);
 	if (rc >= 0) {
@@ -3568,6 +3601,10 @@ static inline bool arg_is_eof(char *arg)
 	       !strncmp(arg, "eof", strlen("eof"));
 }
 
+/* Forward declaration */
+static int propagate_ec_specs(struct ec_spec *ec_specs, int ec_spec_count,
+			      int comp_count, int **ec_map);
+
 /**
  * lfs_mirror_alloc() - Allocate a mirror argument structure.
  *
@@ -3752,12 +3789,162 @@ static int propagate_ec_specs(struct ec_spec *ec_specs, int ec_spec_count,
 	return 0;
 }
 
+/**
+ * add_ec_parity_components() - Add EC parity components to an existing layout.
+ * @layout:          Layout to add parity components to.
+ * @ec_specs:        Array of EC specifications.
+ * @ec_spec_count:   Number of EC specifications.
+ *
+ * Add EC parity components to @layout by starting a new mirror and adding
+ * EC components that match the extents of the data components.
+ *
+ * Return: 0 on success, negative error code on failure.
+ */
+static int add_ec_parity_components(
+				   struct llapi_layout *layout,
+				   struct ec_spec *ec_specs,
+				   int ec_spec_count)
+{
+	struct {
+		uint64_t start;
+		uint64_t end;
+		int ec_idx;
+	} *comp_info = NULL;
+	int *ec_map = NULL;
+	int rc, i, comp_count;
+
+	if (!layout || !ec_specs || ec_spec_count == 0) {
+		errno = EINVAL;
+		return -EINVAL;
+	}
+
+	/* Move to first component of layout */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_FIRST);
+	if (rc) {
+		fprintf(stderr, "error: cannot move to first component: %s\n",
+			strerror(errno));
+		return -errno;
+	}
+
+	/* Count components by iterating through them */
+	comp_count = 1;
+	while (llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_NEXT) == 0)
+		comp_count++;
+
+	/* Propagate EC specs to get mapping for each component */
+	rc = propagate_ec_specs(ec_specs, ec_spec_count, comp_count, &ec_map);
+	if (rc) {
+		fprintf(stderr, "error: failed to propagate EC specs: %s\n",
+			strerror(-rc));
+		return rc;
+	}
+
+	/* Allocate array to store component info */
+	comp_info = calloc(comp_count, sizeof(*comp_info));
+	if (!comp_info) {
+		free(ec_map);
+		return -ENOMEM;
+	}
+
+	/* Move back to first component */
+	rc = llapi_layout_comp_use(layout, LLAPI_LAYOUT_COMP_USE_FIRST);
+	if (rc) {
+		fprintf(stderr, "error: cannot move to first component: %s\n",
+			strerror(errno));
+		rc = -errno;
+		goto out_free;
+	}
+
+	/* Collect extent information from all layout components */
+	for (i = 0; i < comp_count; i++) {
+		int ec_idx = ec_map[i];
+
+		if (ec_idx < 0 || ec_idx >= ec_spec_count) {
+			fprintf(stderr,
+				"error: invalid EC mapping for component %d\n",
+				i);
+			rc = -EINVAL;
+			goto out_free;
+		}
+
+		/* Get component extent */
+		rc = llapi_layout_comp_extent_get(layout,
+						  &comp_info[i].start,
+						  &comp_info[i].end);
+		if (rc) {
+			fprintf(stderr,
+				"error: cannot get component %d extent: %s\n",
+				i, strerror(errno));
+			rc = -errno;
+			goto out_free;
+		}
+
+		comp_info[i].ec_idx = ec_idx;
+
+		/* Move to next component for next iteration */
+		if (i < comp_count - 1) {
+			rc = llapi_layout_comp_use(layout,
+						   LLAPI_LAYOUT_COMP_USE_NEXT);
+			if (rc) {
+				fprintf(stderr,
+					"error: cannot move to next component: %s\n",
+					strerror(errno));
+				rc = -errno;
+				goto out_free;
+			}
+		}
+	}
+
+	/* Add EC components for each data component.
+	 * The first call to llapi_layout_comp_add_ec() will automatically
+	 * start a new mirror.
+	 */
+	for (i = 0; i < comp_count; i++) {
+		uint8_t data_count, parity_count;
+
+		/* Get EC parameters for this component */
+		data_count = ec_specs[comp_info[i].ec_idx].data_count;
+		parity_count = ec_specs[comp_info[i].ec_idx].parity_count;
+
+		/* Add EC parity component */
+		rc = llapi_layout_comp_add_ec(layout, comp_info[i].start,
+					      comp_info[i].end,
+					      data_count, parity_count);
+		if (rc) {
+			fprintf(stderr,
+				"error: cannot add EC component [%llu, %llu] with EC(%u+%u): %s\n",
+				(unsigned long long)comp_info[i].start,
+				(unsigned long long)comp_info[i].end,
+				data_count, parity_count, strerror(errno));
+			rc = -errno;
+			goto out_free;
+		}
+	}
+
+	/* Set the mirror count to 2 (data mirror + parity mirror) */
+	rc = llapi_layout_mirror_count_set(layout, 2);
+	if (rc) {
+		fprintf(stderr, "error: cannot set mirror count: %s\n",
+			strerror(errno));
+		rc = -errno;
+		goto out_free;
+	}
+
+	rc = 0;
+
+out_free:
+	free(comp_info);
+	free(ec_map);
+	return rc;
+}
+
 /**
  * create_ec_parity_mirror() - Create parity mirror from data mirror.
- * @layout:        Layout containing the data mirror.
- * @ec_specs:      Array of EC specifications.
- * @ec_spec_count: Number of EC specifications.
- * @comp_count:    Total number of components in data mirror.
+ * @layout:          Layout containing the data mirror.
+ * @ec_specs:        Array of EC specifications.
+ * @ec_spec_count:   Number of EC specifications.
+ * @comp_count_hint: Hint for number of components.
+ * @set_mirror_count: Whether to set mirror count to 2 (for non-mirror mode).
  *
  * Create a parity mirror by iterating through the data mirror components,
  * extracting their properties (extent, stripe_size, pool), and creating
@@ -3767,7 +3954,8 @@ static int propagate_ec_specs(struct ec_spec *ec_specs, int ec_spec_count,
  */
 static int create_ec_parity_mirror(struct llapi_layout *layout,
 				   struct ec_spec *ec_specs,
-				   int ec_spec_count, int comp_count_hint)
+				   int ec_spec_count, int comp_count_hint,
+				   bool set_mirror_count)
 {
 	struct {
 		uint64_t start;
@@ -3876,14 +4064,21 @@ static int create_ec_parity_mirror(struct llapi_layout *layout,
 		}
 	}
 
-	/* Set mirror count to 2 (1 data + 1 parity) */
-	rc = llapi_layout_mirror_count_set(layout, 2);
-	if (rc) {
-		fprintf(stderr, "error: cannot set mirror count: %s\n",
-			strerror(errno));
-		goto out_free;
+	/* Set mirror count to 2 (1 data + 1 parity) if requested */
+	if (set_mirror_count) {
+		rc = llapi_layout_mirror_count_set(layout, 2);
+		if (rc) {
+			fprintf(stderr, "error: cannot set mirror count: %s\n",
+				strerror(errno));
+			goto out_free;
+		}
 	}
 
+	/* Validate the layout */
+	rc = llapi_layout_sanity(layout, false, false);
+	if (rc)
+		goto out_free;
+
 	rc = 0;
 
 out_free:
@@ -4677,9 +4872,45 @@ create_mirror:
 				}
 
 				lsa.lsa_comp_count++;
-				setstripe_args_init_inherit(&lsa);
+
+				/* Create EC parity mirror if this mirror has EC */
+				if (lsa.lsa_has_ec &&
+				    lsa.lsa_ec_spec_count > 0) {
+					/* Add parity components directly to the
+					 * data mirror's layout
+					 */
+					result = add_ec_parity_components(
+							last_mirror->m_layout,
+							lsa.lsa_ec_specs,
+							lsa.lsa_ec_spec_count);
+					if (result) {
+						fprintf(stderr,
+							"error: %s: failed to add EC parity components\n",
+							progname);
+						lfs_mirror_free(new_mirror);
+						goto error;
+					}
+
+					/* Mark that this layout already contains
+					 * EC parity components. The layout now
+					 * contains 2 mirrors (data + parity).
+					 * We keep m_count at its original value
+					 * (e.g., 1 for -N, 2 for -N2, etc.), and
+					 * set m_has_ec=true so that mirror_create()
+					 * knows to multiply the mirror count by 2.
+					 */
+					last_mirror->m_has_ec = true;
+
+					/* Clear EC specs for next mirror */
+					free(lsa.lsa_ec_specs);
+					lsa.lsa_ec_specs = NULL;
+					lsa.lsa_ec_spec_count = 0;
+					lsa.lsa_has_ec = false;
+				}
 
 				last_mirror->m_next = new_mirror;
+
+				setstripe_args_init_inherit(&lsa);
 			}
 
 			last_mirror = new_mirror;
@@ -4926,15 +5157,40 @@ create_mirror:
 	}
 
 	/* Create EC parity mirror if --ec was specified */
-	if (lsa.lsa_has_ec && layout && !mirror_mode) {
-		result = create_ec_parity_mirror(layout, lsa.lsa_ec_specs,
-						 lsa.lsa_ec_spec_count,
-						 lsa.lsa_comp_count);
-		if (result) {
-			fprintf(stderr,
-				"error: %s: failed to create EC parity mirror\n",
-				progname);
-			goto error;
+	if (lsa.lsa_has_ec && lsa.lsa_ec_spec_count > 0) {
+		if (mirror_mode && last_mirror) {
+			/* Add parity components directly to the data
+			 * mirror's layout
+			 */
+			result = add_ec_parity_components(
+					last_mirror->m_layout,
+					lsa.lsa_ec_specs,
+					lsa.lsa_ec_spec_count);
+			if (result) {
+				fprintf(stderr,
+					"error: %s: failed to add EC parity components\n",
+					progname);
+				goto error;
+			}
+
+			/* Mark that this layout already contains EC parity
+			 * components
+			 */
+			last_mirror->m_has_ec = true;
+		} else if (layout) {
+			/* In non-mirror mode, add parity mirror to layout */
+			result = create_ec_parity_mirror(layout,
+							 lsa.lsa_ec_specs,
+							 lsa.lsa_ec_spec_count,
+							 lsa.lsa_comp_count,
+							 /* set mirror count */
+							 true);
+			if (result) {
+				fprintf(stderr,
+					"error: %s: failed to create EC parity mirror\n",
+					progname);
+				goto error;
+			}
 		}
 	}
 
@@ -5051,14 +5307,7 @@ create_mirror:
 
 	/* Validate EC options */
 	if (lsa.lsa_has_ec) {
-		if (mirror_mode) {
-			fprintf(stderr,
-				"error: %s: --ec cannot be used with -N (mirror mode)\n",
-				progname);
-			goto usage_error;
-		}
-
-		if (!layout) {
+		if (!layout && !mirror_mode) {
 			fprintf(stderr,
 				"error: %s: --ec requires -E to specify component extents\n",
 				progname);
diff --git a/lustre/utils/liblustreapi_layout.c b/lustre/utils/liblustreapi_layout.c
index 984d9cb474..8b832b9af4 100644
--- a/lustre/utils/liblustreapi_layout.c
+++ b/lustre/utils/liblustreapi_layout.c
@@ -3178,6 +3178,8 @@ int llapi_layout_merge(struct llapi_layout **dst_layout,
 		new->llc_extent.e_end = comp->llc_extent.e_end;
 		new->llc_id = comp->llc_id;
 		new->llc_flags = comp->llc_flags;
+		new->llc_dstripe_count = comp->llc_dstripe_count;
+		new->llc_cstripe_count = comp->llc_cstripe_count;
 
 		list_add_tail(&new->llc_list, &new_layout->llot_comp_list);
 		new_layout->llot_cur_comp = new;

</pre>
</body>
</html>
