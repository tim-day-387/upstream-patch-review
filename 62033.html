<html lang="en">
<body>
<pre>
From 03cc82f808298fdbb20b85617195ae3a64bbd88e Mon Sep 17 00:00:00 2001
From: Timothy Day <timday@amazon.com>
Date: Fri, 24 Oct 2025 15:07:05 +0000
Subject: [PATCH 1/1] LU-18687 compat: revert vfree_atomic patch

Revert "LU-18687 compat: use unexported vfree_atomic in kernel"

This reverts commit 87da90954d3524db891f6b5ab2ef0bfa09bf4307.

Test-Parameters: trivial
Signed-off-by: Timothy Day <timday@amazon.com>
Change-Id: I18cb27b3806ebdfaad984e8aa093ed151e99757e
---
 include/linux/libcfs/libcfs_private.h   |  5 ++-
 include/lustre_compat/linux/linux-mem.h | 19 +++++++++
 include/lustre_compat/linux/vmalloc.h   | 16 -------
 libcfs/libcfs/linux/linux-prim.c        | 55 +++++++++++++++++++++++++
 lustre/include/obd_support.h            |  4 +-
 lustre/osd-wbcfs/wbcfs.c                |  1 -
 lustre_compat/symbols.c                 | 12 ------
 7 files changed, 79 insertions(+), 33 deletions(-)
 delete mode 100644 include/lustre_compat/linux/vmalloc.h

diff --git a/include/linux/libcfs/libcfs_private.h b/include/linux/libcfs/libcfs_private.h
index 1634e90325..0935028c69 100644
--- a/include/linux/libcfs/libcfs_private.h
+++ b/include/linux/libcfs/libcfs_private.h
@@ -21,7 +21,8 @@
 #endif
 
 #include <linux/slab.h>
-#include <lustre_compat/linux/vmalloc.h>
+#include <linux/vmalloc.h>
+#include <lustre_compat/linux/linux-mem.h>
 
 #ifdef LIBCFS_DEBUG
 
@@ -210,7 +211,7 @@ do {									\
 	if (likely(ptr)) {						\
 		LIBCFS_FREE_PRE(ptr, (size), "kfreed");			\
 		if (unlikely(s > LIBCFS_VMALLOC_SIZE))			\
-			compat_vfree_atomic(ptr);			\
+			libcfs_vfree_atomic(ptr);			\
 		else							\
 			kfree(ptr);					\
 	}								\
diff --git a/include/lustre_compat/linux/linux-mem.h b/include/lustre_compat/linux/linux-mem.h
index 1a84be363f..9ff699d2dd 100644
--- a/include/lustre_compat/linux/linux-mem.h
+++ b/include/lustre_compat/linux/linux-mem.h
@@ -48,6 +48,13 @@ static inline void bitmap_free(const unsigned long *bitmap)
 }
 #endif /* !HAVE_BITMAP_ALLOC */
 
+/*
+ * Shrinker
+ */
+#ifndef SHRINK_STOP
+# define SHRINK_STOP (~0UL)
+#endif
+
 #ifndef HAVE_MMAP_LOCK
 static inline void mmap_write_lock(struct mm_struct *mm)
 {
@@ -88,6 +95,18 @@ static inline bool mmap_write_trylock(struct mm_struct *mm)
  #endif /* HAVE_MMAP_WRITE_TRYLOCK */
 #endif
 
+#ifdef HAVE_VMALLOC_2ARGS
+#define __ll_vmalloc(size, flags) __vmalloc(size, flags)
+#else
+#define __ll_vmalloc(size, flags) __vmalloc(size, flags, PAGE_KERNEL)
+#endif
+
+void init_libcfs_vfree_atomic(void);
+void exit_libcfs_vfree_atomic(void);
+
+/* atomic-context safe vfree */
+void libcfs_vfree_atomic(const void *addr);
+
 #ifndef HAVE_KFREE_SENSITIVE
 #define kfree_sensitive(x)      kzfree(x)
 #endif
diff --git a/include/lustre_compat/linux/vmalloc.h b/include/lustre_compat/linux/vmalloc.h
deleted file mode 100644
index fc5d952c1a..0000000000
--- a/include/lustre_compat/linux/vmalloc.h
+++ /dev/null
@@ -1,16 +0,0 @@
-/* SPDX-License-Identifier: GPL-2.0 */
-
-#ifndef __LIBCFS_LINUX_VMALLOC_H
-#define __LIBCFS_LINUX_VMALLOC_H
-
-#include <linux/vmalloc.h>
-
-#ifdef HAVE_VMALLOC_2ARGS
-#define __compat_vmalloc(size, flags) __vmalloc(size, flags)
-#else
-#define __compat_vmalloc(size, flags) __vmalloc(size, flags, PAGE_KERNEL)
-#endif
-
-extern void compat_vfree_atomic(const void *addr);
-
-#endif /* __LICBFS_LINUX_VMALLOC_H */
diff --git a/libcfs/libcfs/linux/linux-prim.c b/libcfs/libcfs/linux/linux-prim.c
index e59f0142ee..fe3aa2eaad 100644
--- a/libcfs/libcfs/linux/linux-prim.c
+++ b/libcfs/libcfs/linux/linux-prim.c
@@ -38,10 +38,62 @@
 #include <lustre_compat/linux/shrinker.h>
 #include <lustre_crypto.h>
 
+/*
+ * This is opencoding of vfree_atomic from Linux kernel added in 4.10 with
+ * minimum changes needed to work on older kernels too.
+ */
+
+#ifndef llist_for_each_safe
+#define llist_for_each_safe(pos, n, node)                       \
+	for ((pos) = (node); (pos) && ((n) = (pos)->next, true); (pos) = (n))
+#endif
+
+struct vfree_deferred {
+	struct llist_head list;
+	struct work_struct wq;
+};
+static DEFINE_PER_CPU(struct vfree_deferred, vfree_deferred);
+
+static void free_work(struct work_struct *w)
+{
+	struct vfree_deferred *p = container_of(w, struct vfree_deferred, wq);
+	struct llist_node *t, *llnode;
+
+	llist_for_each_safe(llnode, t, llist_del_all(&p->list))
+		vfree((void *)llnode);
+}
+
+void libcfs_vfree_atomic(const void *addr)
+{
+	struct vfree_deferred *p = raw_cpu_ptr(&vfree_deferred);
+
+	if (!addr)
+		return;
+
+	if (llist_add((struct llist_node *)addr, &p->list))
+		schedule_work(&p->wq);
+}
+EXPORT_SYMBOL(libcfs_vfree_atomic);
+
+void __init init_libcfs_vfree_atomic(void)
+{
+	int i;
+
+	for_each_possible_cpu(i) {
+		struct vfree_deferred *p;
+
+		p = &per_cpu(vfree_deferred, i);
+		init_llist_head(&p->list);
+		INIT_WORK(&p->wq, free_work);
+	}
+}
+
 int __init cfs_arch_init(void)
 {
 	int rc = 0;
 
+	init_libcfs_vfree_atomic();
+
 #ifndef HAVE_WAIT_VAR_EVENT
 	wait_bit_init();
 #endif
@@ -72,6 +124,9 @@ failed:
 
 void __exit cfs_arch_exit(void)
 {
+	/* exit_libcfs_vfree_atomic */
+	__flush_workqueue(system_wq);
+
 	shrinker_debugfs_fini();
 #ifdef CONFIG_LL_ENCRYPTION
 	llcrypt_exit();
diff --git a/lustre/include/obd_support.h b/lustre/include/obd_support.h
index 94a1e11705..6af837abef 100644
--- a/lustre/include/obd_support.h
+++ b/lustre/include/obd_support.h
@@ -883,7 +883,7 @@ do {									      \
 #define __OBD_VMALLOC_VERBOSE(ptr, cptab, cpt, size)			      \
 do {									      \
 	(ptr) = cptab == NULL ?						      \
-		__compat_vmalloc(size, GFP_NOFS | __GFP_HIGHMEM | __GFP_ZERO) :\
+		__ll_vmalloc(size, GFP_NOFS | __GFP_HIGHMEM | __GFP_ZERO) :   \
 		cfs_cpt_vzalloc(cptab, cpt, size);			      \
 	if (unlikely((ptr) == NULL)) {                                        \
 		CERROR("vmalloc of '" #ptr "' (%d bytes) failed\n",           \
@@ -968,7 +968,7 @@ do {									      \
 	if (is_vmalloc_addr(ptr)) {					      \
 		OBD_FREE_PRE(ptr, size, "vfreed");			      \
 		POISON(ptr, 0x5a, size);				      \
-		compat_vfree_atomic(ptr);				      \
+		libcfs_vfree_atomic(ptr);				      \
 		POISON_PTR(ptr);					      \
 	} else {							      \
 		OBD_FREE(ptr, size);					      \
diff --git a/lustre/osd-wbcfs/wbcfs.c b/lustre/osd-wbcfs/wbcfs.c
index a333f60b80..8f3718d6ce 100644
--- a/lustre/osd-wbcfs/wbcfs.c
+++ b/lustre/osd-wbcfs/wbcfs.c
@@ -19,7 +19,6 @@
 #include <linux/statfs.h>
 #include <linux/fs_context.h>
 
-#include <lustre_compat/linux/linux-mem.h>
 #include <lustre_compat.h>
 
 #include "wbcfs.h"
diff --git a/lustre_compat/symbols.c b/lustre_compat/symbols.c
index a353809aa6..74acda294a 100644
--- a/lustre_compat/symbols.c
+++ b/lustre_compat/symbols.c
@@ -69,14 +69,6 @@ int compat_apply_workqueue_attrs(struct workqueue_struct *wq,
 }
 EXPORT_SYMBOL_GPL(compat_apply_workqueue_attrs);
 
-static void (*__vfree_atomic)(const void *addr);
-
-void compat_vfree_atomic(const void *addr)
-{
-	__vfree_atomic(addr);
-}
-EXPORT_SYMBOL_GPL(compat_vfree_atomic);
-
 int lustre_symbols_init(void)
 {
 	int rc;
@@ -96,9 +88,5 @@ int lustre_symbols_init(void)
 	if (!__apply_workqueue_attrs)
 		return -EINVAL;
 
-	__vfree_atomic = cfs_kallsyms_lookup_name("vfree_atomic");
-	if (!__vfree_atomic)
-		return -EINVAL;
-
 	return 0;
 }

</pre>
</body>
</html>
