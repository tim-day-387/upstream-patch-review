From ea6d2d977791ab6ad5638e4365da7229f9f36ce5 Mon Sep 17 00:00:00 2001
From: Arshad Hussain <arshad.hussain@aeoncomputing.com>
Date: Wed, 22 Oct 2025 20:26:44 +0530
Subject: [PATCH 1/1] LU-17000 lnet: Move lp_state from unsigned int to long

Move struct lnet_peer member lp_state from unsigned int
to unsigned long so that logical bit operations can be
moved to test_bit() API's

Test-Parameters: trivial
Signed-off-by: Arshad Hussain <arshad.hussain@aeoncomputing.com>
Change-Id: I2a677e39dffbf5edaa7d9ce5e4c5d4beb9510544
---
 lnet/include/lnet/lib-lnet.h            |  5 ++---
 lnet/include/lnet/lib-types.h           |  2 +-
 lnet/include/uapi/linux/lnet/lnet-dlc.h |  3 +--
 lnet/lnet/peer.c                        | 14 +++++++-------
 4 files changed, 11 insertions(+), 13 deletions(-)

diff --git a/lnet/include/lnet/lib-lnet.h b/lnet/include/lnet/lib-lnet.h
index bd155b32c9..aa3750ecd6 100644
--- a/lnet/include/lnet/lib-lnet.h
+++ b/lnet/include/lnet/lib-lnet.h
@@ -1092,9 +1092,8 @@ lnet_peer_net_set_sel_priority_locked(struct lnet_peer_net *lpn, __u32 priority)
 static inline bool
 lnet_peer_is_multi_rail(struct lnet_peer *lp)
 {
-	if (lp->lp_state & LNET_PEER_MULTI_RAIL)
-		return true;
-	return false;
+	/* LNET_PEER_MULTI_RAIL is defined as BIT(0) */
+	return test_bit(0, &lp->lp_state);
 }
 
 static inline bool
diff --git a/lnet/include/lnet/lib-types.h b/lnet/include/lnet/lib-types.h
index 6ead3ea50a..657e1b3bbc 100644
--- a/lnet/include/lnet/lib-types.h
+++ b/lnet/include/lnet/lib-types.h
@@ -1499,7 +1499,7 @@ struct lnet_peer {
 	spinlock_t		lp_lock;
 
 	/* peer state flags */
-	unsigned		lp_state;
+	unsigned long lp_state;
 
 	/* buffer for data pushed by peer */
 	struct lnet_ping_buffer	*lp_data;
diff --git a/lnet/include/uapi/linux/lnet/lnet-dlc.h b/lnet/include/uapi/linux/lnet/lnet-dlc.h
index 9860fb0649..36b64f3092 100644
--- a/lnet/include/uapi/linux/lnet/lnet-dlc.h
+++ b/lnet/include/uapi/linux/lnet/lnet-dlc.h
@@ -173,11 +173,10 @@ struct lnet_ioctl_pool_cfg {
 
 struct lnet_ioctl_ping_data {
 	struct libcfs_ioctl_hdr ping_hdr;
-
 	__u32 op_param;
 	__u32 ping_count;
 	__u32 ping_flags;
-	__u32 mr_info;
+	__u32 mr_info : 1; /* mr_info is used as a flag, 1 bit is enough */
 	struct lnet_process_id ping_id;
 	struct lnet_process_id __user *ping_buf;
 	lnet_nid_t ping_src;
diff --git a/lnet/lnet/peer.c b/lnet/lnet/peer.c
index 8c6e53e7d8..66d20b79e9 100644
--- a/lnet/lnet/peer.c
+++ b/lnet/lnet/peer.c
@@ -2598,7 +2598,7 @@ void lnet_peer_push_event(struct lnet_event *ev)
 		if (!(lp->lp_state & (LNET_PEER_NO_DISCOVERY |
 				      LNET_PEER_DISCOVERING)) &&
 		     lp->lp_state & LNET_PEER_DISCOVERED) {
-			CDEBUG(D_NET, "Marking %s:0x%x for deletion\n",
+			CDEBUG(D_NET, "Marking %s:0x%lx for deletion\n",
 			       libcfs_nidstr(&lp->lp_primary_nid),
 			       lp->lp_state);
 			lp->lp_state |= LNET_PEER_MARK_DELETION;
@@ -2951,7 +2951,7 @@ lnet_discovery_event_reply(struct lnet_peer *lp, struct lnet_event *ev)
 				      LNET_PEER_NO_DISCOVERY)) &&
 		    (lp->lp_state & (LNET_PEER_DISCOVERED |
 				     LNET_PEER_MULTI_RAIL))) {
-			CDEBUG(D_NET, "Marking %s:0x%x for deletion\n",
+			CDEBUG(D_NET, "Marking %s:0x%lx for deletion\n",
 			       libcfs_nidstr(&lp->lp_primary_nid),
 			       lp->lp_state);
 			lp->lp_state |= LNET_PEER_MARK_DELETION;
@@ -3038,7 +3038,7 @@ lnet_discovery_event_reply(struct lnet_peer *lp, struct lnet_event *ev)
 	}
 
 	/* We're happy with the state of the data in the buffer. */
-	CDEBUG(D_NET, "peer %s data present %u. state = 0x%x\n",
+	CDEBUG(D_NET, "peer %s data present %u. state = 0x%lx\n",
 	       libcfs_nidstr(&lp->lp_primary_nid), lp->lp_peer_seqno,
 	       lp->lp_state);
 	if (lp->lp_state & LNET_PEER_DATA_PRESENT)
@@ -3557,7 +3557,7 @@ __must_hold(&lp->lp_lock)
 
 	INIT_LIST_HEAD(&rlist);
 
-	CDEBUG(D_NET, "peer %s(%p) state %#x\n",
+	CDEBUG(D_NET, "peer %s(%p) state %#lx\n",
 	       libcfs_nidstr(&lp->lp_primary_nid), lp, lp->lp_state);
 
 	/* no-op if lnet_peer_del() has already been called on this peer */
@@ -3755,7 +3755,7 @@ __must_hold(&lp->lp_lock)
 		}
 	}
 out:
-	CDEBUG(D_NET, "peer %s(%p): %d. state = 0x%x\n",
+	CDEBUG(D_NET, "peer %s(%p): %d. state = 0x%lx\n",
 	       libcfs_nidstr(&lp->lp_primary_nid), lp, rc,
 	       lp->lp_state);
 	mutex_unlock(&the_lnet.ln_api_mutex);
@@ -4141,7 +4141,7 @@ static int lnet_peer_discovery(void *arg)
 			 * forcing a Ping or Push.
 			 */
 			spin_lock(&lp->lp_lock);
-			CDEBUG(D_NET, "peer %s(%p) state %#x\n",
+			CDEBUG(D_NET, "peer %s(%p) state %#lx\n",
 				libcfs_nidstr(&lp->lp_primary_nid), lp,
 				lp->lp_state);
 			if (lp->lp_state & (LNET_PEER_MARK_DELETION |
@@ -4159,7 +4159,7 @@ static int lnet_peer_discovery(void *arg)
 				rc = lnet_peer_send_push(lp);
 			else
 				rc = lnet_peer_discovered(lp);
-			CDEBUG(D_NET, "peer %s(%p) state %#x rc %d\n",
+			CDEBUG(D_NET, "peer %s(%p) state %#lx rc %d\n",
 				libcfs_nidstr(&lp->lp_primary_nid), lp,
 				lp->lp_state, rc);
 
